<!doctype html>
<html>
  <head>
    <title>Karhuno WebMatrix</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîÆ</text></svg>"
    />
    <meta charset="UTF-8" />
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <!-- –°—Ç–∏–ª–∏ -->
    <style>
      body {
          font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
          color: #2c3e50;
          line-height: 1.6;
          background-color: #f8f9fa;
          padding: 20px;
          max-width: 1400px;
          margin: 0 auto;
          box-sizing: border-box;
      .container {
          background-color: white;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          padding: 24px;
          width: 100%;
          margin-top: 20px;
          box-sizing: border-box;
      }
      .input-section, .output-section {
          flex: 1;
      }
      textarea {
          width: 100%;
          height: 150px;
          margin-bottom: 10px;
          font-family: monospace;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          padding: 12px;
          font-size: 14px;
          transition: border-color 0.2s ease;
      }
      textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
          border-color: #a5d6a7;
          outline: none;
          box-shadow: 0 0 0 3px rgba(165, 214, 167, 0.1);
      }
      .result {
          border: 1px solid #ccc;
          padding: 10px;
          margin-bottom: 10px;
          white-space: pre-wrap;
      }
      .error { color: red; }
      .success { color: green; }
      #status {
          margin: 10px 0;
          font-weight: bold;
      }
      .controls {
          margin-bottom: 20px;
      }
      button {
          padding: 10px 20px;
          margin-right: 10px;
      }
      #results {
          max-height: 600px;
          overflow-y: auto;
      }
      .settings-panel {
          border: 1px solid #ccc;
          padding: 15px;
          margin-bottom: 20px;
      }
      .collapsible {
          background-color: white;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          margin-bottom: 8px;
          transition: all 0.2s ease;
          color: #444;
          cursor: pointer;
          padding: 18px;
          width: 100%;
          text-align: left;
          outline: none;
          font-size: 15px;
      }
      .active, .collapsible:hover {
          background-color: #f8f9fa;
      }
      .content {
          padding: 0 18px;
          display: none;
          overflow: hidden;
          background-color: #f1f1f1;
      }
      .progress-bar {
          height: 8px;
          border-radius: 4px;
          background-color: #f1f3f5;
          margin: 20px 0;
          width: 100%;
      }

      .progress-bar-fill {
          height: 100%;
          background-color: #a5d6a7;
          transition: width 0.5s ease-in-out;
          border-radius: 4px;
      }

      .readme-panel {
          background-color: #f8f9fa;
          padding: 20px;
          margin-bottom: 20px;
          border-radius: 5px;
      }

      .readme-panel h2 {
          color: #2c3e50;
          margin-bottom: 15px;
      }

      .readme-panel ol {
          padding-left: 20px;
      }

      .readme-panel li {
          margin-bottom: 10px;
      }

      .readme-panel ul {
          padding-left: 20px;
          margin-top: 5px;
      }

      .readme-panel a {
          color: #3498db;
          text-decoration: none;
      }

      .readme-panel a:hover {
          text-decoration: underline;
      }
      .table-container {
          min-width: 100%;
          overflow-x: auto;
          margin-top: 20px;
          border: 1px solid #ddd;
      }

      #resultsTable {
          width: 100%;
          border-collapse: collapse;
      }

      #resultsTable thead {
          position: sticky;
          top: 0;
          background: white;
          z-index: 1;
      }

      #resultsTable th, #resultsTable td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
      }

      #resultsTable th {
          background-color: #f8f9fa;
          color: #495057;
          font-weight: 600;
          padding: 12px 16px;
      }

      #resultsTable td {
          padding: 10px 16px;
          color: #2c3e50;
          border: 1px solid #ddd;
          max-width: 300px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —è—á–µ–π–∫–∏ */
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }

      /* ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ—Ç–∏–ª–∏ –¥–ª—è —è—á–µ–µ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      #resultsTable td:hover {
          white-space: normal;
          word-wrap: break-word;
          position: relative;
          background-color: #f8f9fa;
          z-index: 1;
      }

      /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
      .table-container::-webkit-scrollbar {
          width: 12px;
          height: 12px;
      }

      .table-container::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 6px;
      }

      .table-container::-webkit-scrollbar-thumb {
          background: #888;
          border-radius: 6px;
          border: 3px solid #f1f1f1;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
          background: #555;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ */
      .processing-row {
          background-color: #fff8e1 !important;
      }

      .error-row {
          background-color: #ffebee !important;
      }

      .success-row {
          background-color: #f1f8e9 !important;
      }

      /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
      @keyframes pulse {
          0% { background-color: #fff3cd; }
          50% { background-color: #ffecb5; }
          100% { background-color: #fff3cd; }
      }
      .button-group {
          margin: 25px 0;
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
          width: 100%;
          padding: 0;
      }

      .button-group button,
      .button-group label.button {
          padding: 10px 18px;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          transition: all 0.2s ease;
          border: 1px solid transparent;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          display: inline-flex;
          align-items: center;
          justify-content: center;
          min-width: 150px;
      }

      /* –ö–Ω–æ–ø–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–¥–µ–ª–∞–µ–º –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω–æ–π –∫–∞–∫ –ø–µ—Ä–≤—ã–π —à–∞–≥) */
      .button-group .upload {
          background-color: #e3f2fd;
          color: #1565c0;
          border-color: #bbdefb;
      }
      .button-group .upload:hover {
          background-color: #bbdefb;
          border-color: #90caf9;
      }

      /* –ö–Ω–æ–ø–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ */
      .button-group label.button.upload {
          background-color: #f3e5f5;
          color: #6a1b9a;
          border-color: #e1bee7;
          cursor: pointer;
      }
      .button-group label.button.upload:hover {
          background-color: #e1bee7;
          border-color: #ce93d8;
      }

      /* –í–æ–ª—à–µ–±–Ω–∞—è –∫–Ω–æ–ø–∫–∞ */
      .button-group .magic {
          background-color: #f3e5f5;
          color: #6a1b9a;
          border-color: #e1bee7;
      }
      .button-group .magic:hover {
          background-color: #e1bee7;
          border-color: #ce93d8;
      }

      /* –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µÔøΩÔøΩ—Å—Ç–≤–∏—è */
      .button-group .primary {
          background-color: #e8f5e9;
          color: #2e7d32;
          border-color: #c8e6c9;
      }
      .button-group .primary:hover {
          background-color: #c8e6c9;
          border-color: #a5d6a7;
      }

      /* –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ */
      .button-group .warning {
          background-color: #ffebee;
          color: #c62828;
          border-color: #ffcdd2;
      }
      .button-group .warning:hover {
          background-color: #ffcdd2;
          border-color: #ef9a9a;
      }

      /* –ö–Ω–æ–ø–∫–∏ –≤—ã–≥—Ä—É–∑–∫–∏ */
      .button-group .download {
          background-color: #e3f2fd;
          color: #1565c0;
          border-color: #bbdefb;
      }
      .button-group .download:hover {
          background-color: #bbdefb;
          border-color: #90caf9;
      }
      .table-wrapper {
          /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä, –ø—Ä–∏–º–µ—Ä–Ω–æ —Å —ç–∫—Ä–∞ÔøΩÔøΩ */
          height: calc(100vh - 400px); /* –í—ã—Å–æ—Ç–∞ —ç–∫—Ä–∞–Ω–∞ –º–∏–Ω—É—Å –æ—Ç—Å—Ç—É–ø –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
          min-height: 400px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
          margin: 20px 0;
          border-radius: 12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.05);
          background: white;
      }

      .table-container {
          width: 100%;
          height: 100%;
          overflow: auto; /* –û–±–∞ —Å–∫—Ä–æ–ª–ª–∞ */
          position: relative;
      }

      #resultsTable {
          border-collapse: collapse;
          width: max-content; /* –¢–∞–±–ª–∏—Ü–∞ –∑–∞–π–º–µ—Ç —Å—Ç–æ–ª—å–∫–æ –º–µ—Å—Ç–∞, —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ */
          min-width: 100%; /* –ù–æ –Ω–µ –º–µ–Ω—å—à–µ —à–∏—Ä–∏–Ω—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      }

      #resultsTable thead {
          position: sticky;
          top: 0;
          z-index: 2;
          background: white;
      }

      #resultsTable th {
          position: sticky;
          top: 0;
          background: #f8f9fa;
          border-bottom: 2px solid #ddd;
          padding: 12px 15px;
          text-align: left;
          font-weight: bold;
      }

      #resultsTable td {
          padding: 8px 15px;
          border: 1px solid #ddd;
          max-width: 300px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏ÔøΩÔøΩ–∞ —è—á–µ–π–∫–∏ */
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —è—á–µ–µ–∫ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      #resultsTable td:hover {
          white-space: normal;
          word-wrap: break-word;
          position: relative;
          background-color: #f8f9fa;
          z-index: 1;
      }

      /* –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
      .table-container::-webkit-scrollbar {
          width: 12px;
          height: 12px;
      }

      .table-container::-webkit-scrollbar-track {
          background: #f1f1f1;
          border-radius: 6px;
      }

      .table-container::-webkit-scrollbar-thumb {
          background: #888;
          border-radius: 6px;
          border: 3px solid #f1f1f1;
      }

      .table-container::-webkit-scrollbar-thumb:hover {
          background: #555;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏ */
      .processing-row {
          background-color: #fff3cd;
      }

      .error-row {
          background-color: #ffe6e6;
      }

      .success-row {
          background-color: #f0fff0;
      }

      /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ */
      @keyframes pulse {
          0% { background-color: #fff3cd; }
          50% { background-color: #ffecb5; }
          100% { background-color: #fff3cd; }
      }

      .processing-row {
          animation: pulse 2s infinite;
      }

      .api-key-section {
          background-color: #f8f9fa;
          padding: 15px;
          border-radius: 4px;
          margin-bottom: 20px;
      }

      .api-status {
          display: flex;
          align-items: center;
          gap: 15px;
      }

      #apiKeyMessage {
          font-weight: 500;
      }

      #apiKeyForm {
          margin-top: 10px;
          display: flex;
          gap: 10px;
      }

      #apiKeyInput {
          flex-grow: 1;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .sub-collapsible {
          background-color: #f8f9fa;
          margin: 10px 0;
          font-size: 14px;
          padding: 12px;
      }

      .sub-panel {
          padding: 15px;
          background-color: white;
          border: 1px solid #eee;
          margin-bottom: 20px;
      }

      .api-status {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 10px;
      }

      #apiKeyForm {
          display: flex;
          gap: 10px;
          margin-top: 10px;
      }

      #apiKeyInput {
          flex-grow: 1;
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .presets-section {
          margin: 20px 0;
          padding: 15px;
          background: #f8f9fa;
          border-radius: 4px;
      }

      .presets-controls {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      .preset-select {
          padding: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
          width: 100%;
          margin-bottom: 10px;
      }

      .preset-dialog {
          margin-top: 10px;
          padding: 15px;
          background: white;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .preset-dialog input {
          width: 100%;
          padding: 8px;
          margin-bottom: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .preset-dialog .button-group {
          display: flex;
          gap: 10px;
          justify-content: flex-end;
          margin-top: 10px;
      }

      /* –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø—Ä–µ—Å–µ—Ç–æ–≤ */
      .presets-section .button-group {
          display: flex;
          flex-wrap: wrap;
          gap: 10px;
      }

      .presets-section .button-group button,
      .presets-section .button-group label.button {
          padding: 8px 15px;
          min-width: 120px;
      }

      .preset-dialog input {
          width: 100%;
          padding: 8px;
          margin-bottom: 10px;
          border: 1px solid #ddd;
          border-radius: 4px;
      }

      .preset-dialog .button-group {
          display: flex;
          gap: 10px;
          justify-content: flex-end;
      }

      /* –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â–µ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
      *, *:before, *:after {
          box-sizing: border-box;
      }

      .control-section {
          width: 100%;
          padding: 0;
          margin: 0;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ */
      .chat-section {
          height: calc(100vh - 100px);
          display: flex;
          flex-direction: column;
          position: relative;
      }

      .chat-container {
          flex: 1;
          overflow-y: auto;
          padding: 20px;
          background: white;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          margin-bottom: 20px;
      }

      .message {
          margin-bottom: 15px;
          padding: 15px;
          border-radius: 8px;
          max-width: 80%;
          overflow-wrap: break-word;
      }

      .user-message {
          background-color: #e3f2fd;
          margin-left: auto;
      }

      .ai-message {
          background-color: #f5f5f5;
          margin-right: auto;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è Markdown */
      .message pre {
          background: #f6f8fa;
          border-radius: 6px;
          padding: 16px;
          overflow-x: auto;
      }

      .message code {
          font-family: 'Consolas', 'Monaco', monospace;
          font-size: 0.9em;
          padding: 0.2em 0.4em;
          background: #f6f8fa;
          border-radius: 3px;
      }

      .message pre code {
          padding: 0;
          background: transparent;
      }

      .message table {
          border-collapse: collapse;
          width: 100%;
          margin: 10px 0;
      }

      .message th, .message td {
          border: 1px solid #ddd;
          padding: 8px;
          text-align: left;
      }

      .message th {
          background-color: #f6f8fa;
      }

      .message blockquote {
          border-left: 4px solid #ddd;
          margin: 0;
          padding-left: 16px;
          color: #666;
      }

      .message img {
          max-width: 100%;
          height: auto;
      }

      .message ul, .message ol {
          padding-left: 20px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ */
      .code-wrapper {
          position: relative;
      }

      .copy-button {
          position: absolute;
          top: 5px;
          right: 5px;
          padding: 5px 10px;
          background: #fff;
          border: 1px solid #ddd;
          border-radius: 4px;
          font-size: 12px;
          cursor: pointer;
          opacity: 0;
          transition: opacity 0.2s;
      }

      .code-wrapper:hover .copy-button {
          opacity: 1;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è drag-and-drop */
      .drag-overlay {
          display: none;
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(33, 150, 243, 0.1);
          border: 3px dashed #2196f3;
          border-radius: 8px;
          z-index: 1000;
          pointer-events: none;
      }

      .drag-overlay.active {
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5em;
          color: #2196f3;
      }

      .loading-indicator {
          display: none;
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(255, 255, 255, 0.9);
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          z-index: 1001;
      }

      .loading-indicator.active {
          display: block;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–≤–æ–¥–∞ */
      .input-container {
          display: flex;
          gap: 10px;
          align-items: flex-start;
      }

      #messageInput {
          flex: 1;
          padding: 12px;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          resize: vertical;
          height: 100px;
          min-height: 100px;
          max-height: 50vh;
          overflow-y: auto;
          line-height: 1.5;
          font-family: inherit;
          box-sizing: border-box;
      }

      .input-buttons {
          display: flex;
          flex-direction: column;
          gap: 10px;
      }

      .input-buttons .button {
          min-width: 120px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ */
      .checkbox-group {
          display: flex;
          gap: 20px;
          margin: 15px 0;
          align-items: center;
      }

      .checkbox-item {
          display: flex;
          align-items: center;
          margin: 0;
      }

      .checkbox-item input[type="checkbox"] {
          margin-right: 10px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–∞—ÇÔøΩÔøΩ */
      .button-right {
          margin-left: auto !important;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —á–∞—Ç–∞ */
      .chat-settings {
          background-color: #f8f9fa;
          padding: 15px;
          border-radius: 8px;
          margin-bottom: 20px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ */
      #systemPrompt {
          width: 100%;
          min-height: 100px;
          margin: 10px 0;
          padding: 12px;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          font-family: inherit;
          resize: vertical;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤ —á–∞—Ç–∞ */
      .chat-dialog {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          z-index: 1000;
      }

      .chat-dialog h3 {
          margin-top: 0;
          margin-bottom: 15px;
      }

      .chat-dialog input {
          width: 100%;
          padding: 8px;
          margin: 10px 0;
          border: 1px solid #dee2e6;
          border-radius: 4px;
      }

      .chat-dialog select {
          width: 100%;
          padding: 8px;
          margin: 10px 0;
          border: 1px solid #dee2e6;
          border-radius: 4px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö */
      .chat-dialog .button-group {
          display: flex;
          gap: 10px;
          justify-content: flex-end;
          margin-top: 15px;
      }

      .chat-dialog .button-group button {
          min-width: 80px;
      }

      /* –ü–æ–≤—ã—à–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ—Å—Ç—å —Å—Ç–∏–ª–µ–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ —á–∞—Ç–∞ */
      .chat-section .input-buttons .button.primary,
      .settings-panel .button-group .button.primary {
          background-color: #e8f5e9 !important;
          color: #2e7d32 !important;
          border-color: #c8e6c9 !important;
          min-width: 120px;
          height: 45px;
      }

      .chat-section .input-buttons .button.upload,
      .settings-panel .button-group .button.upload {
          background-color: #f3e5f5 !important;
          color: #6a1b9a !important;
          border-color: #e1bee7 !important;
          min-width: 120px;
          height: 45px;
      }

      .chat-section .input-buttons .button.download,
      .settings-panel .button-group .button.download {
          background-color: #e3f2fd !important;
          color: #1565c0 !important;
          border-color: #bbdefb !important;
          min-width: 120px;
          height: 45px;
      }

      .chat-section .input-buttons .button.warning,
      .settings-panel .button-group .button.warning {
          background-color: #ffebee !important;
          color: #c62828 !important;
          border-color: #ffcdd2 !important;
          min-width: 120px;
          height: 45px;
      }

      /* –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
      .chat-section .input-buttons .button.primary:hover,
      .settings-panel .button-group .button.primary:hover {
          background-color: #c8e6c9 !important;
          border-color: #a5d6a7 !important;
      }

      .chat-section .input-buttons .button.upload:hover,
      .settings-panel .button-group .button.upload:hover {
          background-color: #e1bee7 !important;
          border-color: #ce93d8 !important;
      }

      .chat-section .input-buttons .button.download:hover,
      .settings-panel .button-group .button.download:hover {
          background-color: #bbdefb !important;
          border-color: #90caf9 !important;
      }

      .chat-section .input-buttons .button.warning:hover,
      .settings-panel .button-group .button.warning:hover {
          background-color: #ffcdd2 !important;
          border-color: #ef9a9a !important;
      }

      /* –°ÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩÔøΩ–ª–∏ ÔøΩÔøΩ–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
      .button-group button:disabled,
      .button-group label.button:disabled {
          background-color: #e9ecef !important;
          color: #adb5bd !important;
          border-color: #dee2e6 !important;
          cursor: not-allowed;
          opacity: 0.7;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—É–ª—Ç–∏–ø–æ–≤ –∫–Ω–æ–ø–æ–∫ */
      .button-group button[title]:not(:disabled):hover::after,
      .button-group label.button[title]:not(:disabled):hover::after {
          display: none;
      }

      .button-group button[title]:disabled:hover::after,
      .button-group label.button[title]:disabled:hover::after {
          content: "Please upload data table in Excel or CSV format first to use Magic Prompt and start analysis";
          position: absolute;
          bottom: 100%;
          left: 50%;
          transform: translateX(-50%);
          padding: 8px 12px;
          background: #333;
          color: white;
          border-radius: 4px;
          font-size: 13px;
          white-space: normal;
          max-width: 250px;
          text-align: center;
          z-index: 10;
          margin-bottom: 5px;
      }

      .checkbox-wrapper {
          margin: 10px 0;
          display: flex;
          align-items: center;
          gap: 8px;
      }

      .checkbox-wrapper input[type="checkbox"] {
          margin: 0;
      }

      .checkbox-wrapper label {
          font-size: 14px;
          color: #666;
      }
    </style>
  </head>
  <body>
    <h1>Karhuno WebMatrix</h1>

    <button type="button" class="collapsible">üìñ README</button>
    <div class="content readme-panel">
      <div class="readme-container">
        <h1>WebMatrix</h1>

        <div class="intro-section">
          <h2>Karhuno Data Analysis Assistant</h2>

          <p class="intro-text">
            Hi there! WebMatrix is a compact tool that helps automate routine work with tables,
            search, and data analysis using AI. Just open the file in your browser, upload a table,
            and describe in plain words what you need to find or analyze.
          </p>

          <ul>
            <li>‚ú® No installation required</li>
            <li>ÔøΩÔøΩÔøΩÔøΩ Your data stays local</li>
            <li>‚ö° Quick results</li>
            <li>üìä One-click analysis</li>
            <li>üîÑ Works in background</li>
            <li>üíª Won't disrupt your workflow</li>
            <li>üí¨ Built-in AI assistant</li>
            <li>üîÑ Interactive result analysis</li>
            <li>üìù Data-driven prompt improvement</li>
          </ul>
        </div>

        <button type="button" class="collapsible">üéØ What can WebMatrix do?</button>
        <div class="content">
          <div class="cases-grid">
            <div class="case">
              <h3>Company Analysis</h3>
              <p>
                Automatically researches websites, finds key information about business scale,
                operations, and specialization
              </p>
            </div>

            <div class="case">
              <h3>Data Processing</h3>
              <p>Classifies, categorizes, and enriches tabular data with additional insights</p>
            </div>

            <div class="case">
              <h3>Automation</h3>
              <p>Uses AI to handle routine table tasks that you'd normally do manually</p>
            </div>

            <div class="case">
              <h3>Validation</h3>
              <p>
                Checks data against specified criteria, identifies discrepancies and finds
                supporting evidence
              </p>
            </div>
            <div class="case">
              <h3>Interactive Analysis</h3>
              <p>
                Discusses results with AI, helps improve prompts and uncovers hidden patterns in
                data
              </p>
            </div>
          </div>
        </div>

        <button type="button" class="collapsible">üîÑ How does it work?</button>
        <div class="content">
          <ol>
            <li>üì§ Upload your data table (for example, a list of companies to analyze)</li>
            <li>üí¨ Describe in plain English what you need to find or verify</li>
            <li>ü§ñ WebMatrix automatically creates an optimal AI query and response columns</li>
            <li>üìä AI analyzes the data and adds new columns with results to your table</li>
            <li>
              üí° Discuss results with AI assistant to improve analysis quality and find non-obvious
              patterns
            </li>
          </ol>
        </div>

        <button type="button" class="collapsible">üìö Ready-made recipes</button>
        <div class="content">
          <div class="recipe-cards">
            <div class="recipe">
              <h3>üîç B2B Company Analysis</h3>
              <p>Automatically determines:</p>
              <ul>
                <li>Business size and geography</li>
                <li>Main areas of operation</li>
                <li>Potential for collaboration</li>
                <li>Indicators of international trade</li>
              </ul>
              <p>Example query:</p>
              <p>
                <i
                  >Analyze the website of company {{company_name}} {{website}} and evaluate:<br />
                  - Scale of international operations<br />
                  - Presence of currency operations<br />
                  - Potential as a B2B client<br />
                  - Main regions of presence</i
                >
              </p>
            </div>

            <div class="recipe">
              <h3>üìã Keyword Improvement</h3>
              <p>Searches for key phrases in "good" signals</p>
              <ul>
                <li>Reads high-quality signals</li>
                <li>Finds key phrases</li>
                <li>Creates a list</li>
              </ul>
              <p>Example query:</p>
              <p>
                <i
                  >Read the article and find key phrases that can be used to find similar news on
                  Google:<br />
                  - Startup attracted investments.<br />
                  - Operates in the {{industry}} industry.<br />
                  - Has a distributed team.<br />
                  {{article_text}}</i
                >
              </p>
            </div>

            <div class="recipe">
              <h3>üìä Data Enrichment</h3>
              <p>Enriches tables with information:</p>
              <ul>
                <li>Descriptions from open sources</li>
                <li>Categorization by criteria</li>
                <li>Potential assessment</li>
                <li>Identifying features</li>
              </ul>
              <p>Example query:</p>
              <p>
                <i
                  >Enrich the data about the company:<br />
                  - Brief business description<br />
                  - Main areas of operation<br />
                  - Annual revenue assessment<br />
                  - Country of the main office location</i
                >
              </p>
            </div>
          </div>
        </div>

        <button type="button" class="collapsible">üí¨ AI assistant</button>
        <div class="content">
          <div class="chat-features">
            <h3>Chat capabilities</h3>
            <ul>
              <li>Analysis of the entire table for pattern discovery</li>
              <li>Checking results for errors and hallucinations</li>
              <li>Data-driven prompt improvement</li>
              <li>Generating key phrases for search</li>
              <li>Creating summaries of results</li>
            </ul>

            <h3>Examples of use</h3>

            <div class="chat-example">
              <h4>üìä Analysis results</h4>
              <p>After processing the data, ask:</p>
              <p>
                <i>
                  "Analyze the results and find:<br />
                  - Companies with the highest potential<br />
                  - Common characteristics of successful cases<br />
                  - Possible false positives<br />
                  - What can be improved in the prompt"</i
                >
              </p>
            </div>

            <div class="chat-example">
              <h4>üîç Improvement of search</h4>
              <p>Upload successful cases and ask:</p>
              <p>
                <i>
                  "Based on these successful findings:<br />
                  - Create a list of key phrases for searching similar signals<br />
                  - Find common traits in descriptions and news<br />
                  - Identify common features of websites"</i
                >
              </p>
            </div>

            <div class="chat-example">
              <h4>üë• Role-play scenarios</h4>
              <p>Use specialized roles:</p>
              <p>
                <i>
                  "You are the CEO of a fintech company, looking for partners.<br />
                  Look at the analysis results and:<br />
                  - Evaluate the attractiveness of the found companies<br />
                  - Point out what to pay attention to during the first contact<br />
                  - Suggest how to improve the search potential"</i
                >
              </p>
            </div>
          </div>
        </div>

        <button type="button" class="collapsible">üí° Useful tips</button>
        <div class="content">
          <div class="tips-grid">
            <div class="tip">
              <h3>üéØ Analysis accuracy</h3>
              <ul>
                <li>Use specific evaluation criteria</li>
                <li>Specify priority parameters</li>
                <li>Ask for confirmation of conclusions with links</li>
                <li>Don't ask too many questions in one go</li>
                <li>Explicitly specify models what and how they should do</li>
                <li>
                  Manually analyze the first lines and compare the model's answers with expected
                  ones
                </li>
              </ul>
            </div>

            <div class="tip">
              <h3>‚ö° Work speed</h3>
              <ul>
                <li>Save successful prompts</li>
                <li>The Magic button can be used multiple times</li>
                <li>Monitor the first results and adjust the prompt</li>
                <li>
                  In "incognito" mode, it can work in multiple instances with different API keys
                </li>
              </ul>
            </div>

            <div class="tip">
              <h3>üìà Improvement of results</h3>
              <ul>
                <li>Check the first results</li>
                <li>Adjust the prompt as needed</li>
                <li>Specify typical model errors in the prompt</li>
                <li>Use AI to improve prompts based on data</li>
                <li>Always remember: Models lie very convincingly.</li>
              </ul>
            </div>
            <div class="tip">
              <h3>üí¨ Working with chat</h3>
              <ul>
                <li>Use chat to check results for errors</li>
                <li>Create specialized roles for specific tasks</li>
                <li>Analyze the entire table at once for pattern discovery</li>
                <li>Generate key phrases based on successful findings</li>
                <li>Discuss results from different perspectives (analyst, client, lead)</li>
              </ul>
            </div>
          </div>
        </div>

        <button type="button" class="collapsible">üöÄ Quick start</button>
        <div class="content">
          <div class="setup-steps">
            <div class="step">
              <h3>1Ô∏è‚É£ Get API key</h3>
              <p>It will take literally a minute:</p>
              <ol>
                <li>
                  Open
                  <a href="https://makersuite.google.com/app/apikey" target="_blank"
                    >makersuite.google.com</a
                  >
                </li>
                <li>Click "Create API Key"</li>
                <li>Save the key in a secure place</li>
              </ol>
            </div>

            <div class="step">
              <h3>2Ô∏è‚É£ Run WebMatrix</h3>
              <ol>
                <li>Open WebMatrix.html in your browser</li>
                <li>Enter the API key (it will be saved in your browser)</li>
                <li>Upload your table</li>
                <li>Describe the task in plain English</li>
                <li>Click "Magic" ‚ú®</li>
              </ol>
            </div>
          </div>

          <div class="magic-button-section">
            <h2>‚ú® About the "Magic" button</h2>
            <p>This is your assistant in creating effective prompts. It analyzes:</p>
            <ul>
              <li>The structure of your table</li>
              <li>Example data</li>
              <li>Task description</li>
            </ul>
            <p>And automatically creates an optimal prompt for analysis.</p>
          </div>
        </div>

        <button type="button" class="collapsible">‚ÑπÔ∏è Important to know</button>
        <div class="content">
          <div class="note-cards">
            <div class="note">
              <h3>üîí Security</h3>
              <p>
                The API key is stored only in your browser. It is not transmitted or saved anywhere.
              </p>
            </div>

            <div class="note">
              <h3>üíæ Data persistence</h3>
              <p>
                Presets and settings are stored locally. Important presets are better to export.
              </p>
            </div>

            <div class="note">
              <h3>üåê Accessibility</h3>
              <p>
                If there are issues with access, use VPN extensions for your browser (Browsec,
                ZenMate, Urban VPN).
              </p>
            </div>

            <div class="note">
              <h3>üîÑ Background operation</h3>
              <p>
                Use a separate browser or profile for background operation of WebMatrix. This will
                allow you to run multiple instances with different API keys without disrupting your
                main workflow.
              </p>
            </div>

            <div class="note">
              <h3>üí° Feedback</h3>
              <p>
                All ideas, suggestions, and bug reports should be sent to the developer - Pavel,
                Telegram @kcalls
              </p>
            </div>

            <div class="note">
              <h3>ü§ù Share experience with colleagues</h3>
              <p>
                Share successful presets and case studies of WebMatrix application with the team.
              </p>
            </div>
          </div>
        </div>

        <div class="quality-tips">
          <h2>üéØ For the best results</h2>
          <ul>
            <li>Start with analyzing a small sample of data</li>
            <li>Check results after 5-10 minutes after starting</li>
            <li>Adjust the prompt as needed</li>
            <li>Save successful prompts in presets</li>
            <li>Don't forget to check the results of the AI</li>
          </ul>
        </div>
        <p>
          Remember, the final stage of checking the results is your expertise. The client should
          never receive hallucinations in the report.
        </p>
      </div>
    </div>

    <button type="button" class="collapsible">‚öôÔ∏è Settings</button>
    <div class="content settings-panel">
      <button type="button" class="collapsible sub-collapsible">üîë API Key</button>
      <div class="content sub-panel">
        <div id="apiKeyStatus" class="api-status">
          <span id="apiKeyMessage">API Key required</span>
          <button onclick="showApiKeyForm()" class="button primary" id="apiKeyButton">
            Set API Key
          </button>
        </div>
        <div id="apiKeyForm" style="display: none">
          <input type="password" id="apiKeyInput" placeholder="Enter Gemini API Key" />
          <div class="checkbox-wrapper">
            <input type="checkbox" id="isCommercialKey" />
            <label for="isCommercialKey">Commercial API Key (no rate limits)</label>
          </div>
          <button onclick="saveApiKey()" class="button primary">Save</button>
          <button onclick="hideApiKeyForm()" class="button warning">Cancel</button>
        </div>
      </div>

      <div class="presets-section">
        <h3>Presets</h3>
        <div class="presets-controls">
          <select id="presetSelect" class="preset-select">
            <option value="">Select preset...</option>
          </select>

          <div class="button-group">
            <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏ -->
            <button onclick="loadPreset()" class="primary">üìÇ Load</button>
            <button onclick="showSavePresetDialog()" class="primary">üíæ Save</button>
            <button onclick="deletePreset()" class="warning">üóëÔ∏è Delete</button>

            <!-- –ò–º–ø–æ—Ä—Ç/ÔøΩÔøΩ–∫—Å–ø–æ—Ä—Ç -->
            <input
              type="file"
              id="importPreset"
              accept=".json"
              style="display: none"
              onchange="importPresets(event)"
            />
            <label for="importPreset" class="button upload">üì• Import Presets</label>
            <button onclick="showExportPresetDialog()" class="download">üì§ Export Presets</button>
          </div>
        </div>

        <!-- –î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ—Å–µ—Ç–∞ -->
        <div id="savePresetDialog" style="display: none" class="preset-dialog">
          <input type="text" id="presetName" placeholder="Enter preset name" />
          <div class="button-group">
            <button onclick="savePreset()" class="primary">Save</button>
            <button onclick="hideSavePresetDialog()" class="warning">Cancel</button>
          </div>
        </div>

        <!-- –î–∏–∞–ª–æ–≥ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ø—Ä–µ—Å–µ—Ç–æ–≤ -->
        <div id="exportPresetDialog" style="display: none" class="preset-dialog">
          <input type="text" id="exportPresetName" placeholder="Enter export file name" />
          <div class="button-group">
            <button onclick="doExportPresets()" class="primary">Export</button>
            <button onclick="hideExportPresetDialog()" class="warning">Cancel</button>
          </div>
        </div>
      </div>

      <h3>Prompt</h3>
      <textarea id="promptTemplate">
Analyze this website: {{url}}

Your task is to evaluate if the company could benefit from international payment and fintech solutions.
Return response in this JSON format only:
{
    "company_name": string,
    "has_international_offices": boolean,
    "has_currency_exchange": boolean,
    "has_money_transfer": boolean,
    "sales_potential": number (0-5),
    "estimated_yearly_fx_volume": string,
    "locations": string,
    "company_summary": string,
    "lead_quality_notes": string,
    "proof_url": string
}</textarea
      >

      <h3>Output Columns (one per line)</h3>
      <textarea id="outputColumns">
company_name
has_international_offices
has_currency_exchange
has_money_transfer
sales_potential
estimated_yearly_fx_volume
locations
company_summary
lead_quality_notes
proof_url</textarea
      >
    </div>

    <div class="container">
      <div class="control-section">
        <h2>Input Data</h2>
        <div class="button-group">
          <input
            type="file"
            id="inputFile"
            accept=".csv,.xlsx,.xls"
            onchange="handleFileUpload(event)"
            style="display: none"
          />
          <label for="inputFile" class="button upload">üìÑ Upload Data</label>
          <button
            class="magic"
            onclick="generatePrompt()"
            id="magicButton"
            title="Upload data first"
          >
            ‚ú® Magic Prompt
          </button>
          <button
            class="primary"
            onclick="startProcessing()"
            id="startButton"
            title="Upload data first"
          >
            ‚ñ∂Ô∏è Start Analysis
          </button>
          <button class="warning" onclick="stopProcessing()">‚èπÔ∏è Stop</button>
          <button class="download" onclick="downloadResults()">üíæ Save JSON</button>
          <button class="download" onclick="downloadCSV()">üìä Save CSV</button>
          <button class="download" onclick="downloadExcel()">üìë Save Excel</button>
        </div>
        <div id="status"></div>
      </div>

      <div class="results-section">
        <h2>Results</h2>
        <div class="table-wrapper">
          <div class="table-container">
            <table id="resultsTable">
              <thead>
                <tr id="headerRow"></tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-bar-fill" style="width: 0%"></div>
    </div>

    <button type="button" class="collapsible">üí¨ Chat</button>
    <div class="content">
      <button type="button" class="collapsible">‚öôÔ∏è Chat Settings</button>
      <div class="content settings-panel">
        <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã -->
        <h3>System Prompts</h3>
        <div class="button-group">
          <button class="button upload" onclick="loadPrompt()">ÔøΩÔøΩÔøΩÔøΩ Load Prompt</button>
          <button class="button download" onclick="savePrompt()">üíæ Save Prompt</button>
          <input
            type="file"
            id="promptFile"
            accept=".txt,.md"
            style="display: none"
            onchange="loadPromptFromFile(event)"
          />
          <button class="button upload" onclick="document.getElementById('promptFile').click()">
            üì• Import from File
          </button>
          <button class="button download" onclick="exportPrompt()">üì§ Export to MD</button>
          <button class="button warning button-right" onclick="clearHistory()">
            üóëÔ∏è Clear History
          </button>
        </div>

        <textarea
          id="systemPrompt"
          placeholder="Enter system prompt here..."
          rows="5"
          style="width: 100%; margin: 10px 0"
        ></textarea>

        <!-- –ß–µ–∫–±–æ–∫—ÅÔøΩÔøΩÔøΩÔøΩ –¥–ª—è –∫–æ–Ω—ÇÔøΩÔøΩÔøΩÔøΩ—Å—Ç–∞ -->
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="showTable" />
            <label for="showTable">LLM sees table data</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="showPreset" />
            <label for="showPreset">LLM sees preset</label>
          </div>
        </div>
      </div>

      <!-- –ß–∞—Ç -->
      <div class="chat-section">
        <div class="drag-overlay">
          <div>Drop files here</div>
        </div>
        <div class="loading-indicator">Processing file... üìÑ</div>
        <div class="chat-container" id="chatContainer">
          <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>

        <div class="input-container">
          <textarea
            id="messageInput"
            placeholder="Type your message here... (Enter to send, Shift+Enter for new line)"
            rows="1"
          ></textarea>
          <div class="input-buttons">
            <button class="button primary" onclick="sendMessage()">üì§ Send</button>
            <button class="button upload" onclick="document.getElementById('uploadFile').click()">
              üìé Upload File
            </button>
            <input
              type="file"
              id="uploadFile"
              style="display: none"
              onchange="handleChatFileUpload(event)"
            />
          </div>
        </div>
      </div>
    </div>

    <script>
      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –∫–ª—é—á–∞
      let GEMINI_API_KEY = '';
      let isProcessing = false;
      let results = [];

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è API
      const API_CONFIG = {
        BASE_URL: 'https://generativelanguage.googleapis.com/v1beta/models',
        MODEL: 'gemini-1.5-pro',
        ENDPOINT: ':generateContent',
      };
      // –î–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
      const tableContext = `Available columns for analysis:
                  {{table_columns}}

                  Sample data:
                  {{table_sample}}`;

      const userTask = `User task description:
                  {{user_task}}`;

      // –ú–µ—Ç–∞–ü—Ä–æ–º–ø—Ç –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
      const metaPrompt = `CRITICAL REQUIREMENTS:
                  Your response MUST be at least 3000 characters and STRICTLY follow the format below.
                  Any deviation from the format will cause system errors.

                  <INSTRUCTIONS>
                  You are an expert in creating prompts for data analysis. Your task is to create a detailed prompt that will be used by an AI model for line-by-line data analysis in an automated system.

                  The prompt you create will be used as a template, where values from columns marked as {{column_name}} will be automatically substituted.
                  Some columns are filled with data - this is the source material, refer to them in the prompt if the data will help the model in analysis.
                  Other columns (optionally) will be filled with "Pending..." - these columns are intended for model responses, list them at the end of the answer. You can add columns for responses if necessary, but no more than 10 questions to the model.
                  The prompt must contain questions for the model corresponding to each response column, and require answers in json format, without additional text (the response is processed by the program)
                  Give detailed, comprehensive instructions for the model, with examples and explanations of how to handle non-standard situations.

                  Available data context:
                  ${tableContext}

                  User task description:
                  "${userTask}"

                  TABLE STRUCTURE HANDLING:
                  1. Analyze the provided table structure:
                     - Columns with data are your input variables - reference them using {{column_name}}
                     - Columns with "Pending..." are reserved for model responses
                     - You can suggest better column names or additional columns for responses
                     - Remove columns that don't match the analysis task
                     - Maximum 10 response columns total

                  2. Column Usage Rules:
                     - Input columns: Use as variables in prompt, e.g., "analyze {{website}}"
                     - Response columns: Must match JSON fields in model's response
                     - The number and order of columns must STRICTLY correspond to the number and order of fields in the JSON response from the analyst model, otherwise there will be parsing issues.
                     - JSON structure must be flat (no nested objects)
                     - Column names: use only letters, numbers, and underscores

                  3. Response Format:
                     - JSON fields will be mapped to columns in order
                     - Each field in JSON must correspond to a column in COLUMNS section
                     - Do not include input columns in COLUMNS section
                     - List only columns needed for model's response

                  </INSTRUCTIONS>

                  <PROMPT REQUIREMENTS>

                  1. Prompt structure must contain:
                     - Clear description of analysis task
                     - Detailed data processing instructions
                     - Questions and tasks for the model
                     - Result validation rules
                     - Response formats for different situations
                     - Examples of good and bad responses, example response for errors or non-standard situations
                     - Write prompt in English unless user explicitly requested another language

                  2. Data handling rules for the model:
                     - Reference available columns through {{column_name}}
                     - Strip URLs of protocols and www, try accessing site again once if failed
                     - Check availability of data sources
                     - Validate input data
                     - Make no assumptions when data is missing

                  3. JSON response format for model:
                     - Flat structure only (no nested objects or arrays)
                     - Numerical ratings on 0-10 scale
                     - Text fields for descriptions and comments
                     - "N/A" for missing data
                     - Mandatory field for errors/issues description

                  4. Mandatory response examples in composed prompt
                     - Successful response example
                     - Limited data example
                     - Non-standard situation response example

                  5. Special instructions:
                     - Do not use personal data (contacts, names) unless explicitly required by the task
                     - Avoid binary assessments (yes/no), use 0-10 scale
                     - Always indicate data source
                     - Describe reasons for low ratings
                     - Note uncertainty in data

                  6. Must include in prompt:
                      - Set model role based on task and data type
                      - Requirement not to make assumptions, write either verified data or report verification impossibility
                      - If task requires visiting sites, give explicit instruction for model to visit site and reference URL column
                      - Questions and tasks for model
                      - 3 JSON response examples - good analysis result, negative and response for non-standard situation
                      - Requirement to respond strictly in specified JSON structure and explanation that data is parsed by program

                  7. User interaction instructions:
                     - Prompt must be written in English unless user requested another language
                     - If you received a valid prompt in another language - translate it to English
                     - User can write instructions both for you and for inclusion in prompt. Distinguish them and process correctly
                     - If user didn't provide table Case Description - write at beginning of prompt, highlighted in red html tag, that there's no data for table analysis (user task description), need to upload file and click "magic" button again

                  REMEMBER, excessive prompt is better than insufficient. Success of large data volume analysis depends on quality of your work. Write detailed prompt as if writing instruction for human.




                  </PROMPT REQUIREMENTS>

                  <COMPLETE_RESPONSE_EXAMPLE>
                  ===PROMPT_START===
                  Here's an example of a complete, properly formatted response:

                  PROMPT:
                  You are an experienced financial analyst evaluating companies for potential fintech service sales. Your task is to analyze the company's website and determine if they could benefit from international payment solutions.

                  NALYSIS INSTRUCTIONS:
                  1. Website Access:
                     - Try opening site {{website}} without http/https/www
                     - Make one retry attempt if failed
                     - Return error response if site remains inaccessible

                  2. Company Analysis:
                     - Determine exact name and business type
                     - Assess operation scale and geographic presence
                     - Analyze current financial services and international activities
                     - Find evidence of cross-border operations

                  3. Potential Assessment:
                     - Rate international presence (0-10)
                     - Rate technical readiness (0-10)
                     - Rate target profile match (0-10)

                  4. Evidence Collection:
                     - Check About/Services sections
                     - Look for international operations mentions
                     - Find international office locations
                     - Document specific countries/regions
                     - Save URLs with evidence

                  5. Data Validation:
                     - Use only publicly available information
                     - Make no assumptions without evidence
                     - Note any uncertainty in assessments
                     - Indicate data sources
                     - Document any access issues

                  RESPONSE FORMAT:
                  Return strictly JSON format without additional text:

                  {
                      "company_name": "Exact name or domain",
                      "has_international_offices": boolean,
                      "has_currency_exchange": boolean,
                      "has_money_transfer": boolean,
                      "sales_potential": number (0-5),
                      "estimated_yearly_fx_volume": "Estimate or N/A",
                      "locations": "List of countries/regions or N/A",
                      "company_summary": "Brief description up to 300 characters",
                      "lead_quality_notes": "Important observations, limitations",
                      "proof_url": "URL with evidence or N/A"
                  }

                  RESPONSE EXAMPLES:

                  Successful analysis:
                  {
                      "company_name": "Global Trade Solutions",
                      "has_international_offices": true,
                      "has_currency_exchange": true,
                      "has_money_transfer": true,
                      "sales_potential": 5,
                      "estimated_yearly_fx_volume": ">$10M",
                      "locations": "USA, EU, Asia",
                      "company_summary": "Large trading platform with developed international infrastructure",
                      "lead_quality_notes": "High potential, ready infrastructure, active international operations",
                      "proof_url": "globaltrade.com/about"
                  }

                  Limited data:
                  {
                      "company_name": "Local Shop",
                      "has_international_offices": false,
                      "has_currency_exchange": false,
                      "has_money_transfer": false,
                      "sales_potential": 1,
                      "estimated_yearly_fx_volume": "N/A",
                      "locations": "Local only",
                      "company_summary": "Local shop without international presence",
                      "lead_quality_notes": "Limited potential, no signs of international operations",
                      "proof_url": "localshop.com"
                  }

                  Error:
                  {
                      "company_name": "N/A",
                      "has_international_offices": false,
                      "has_currency_exchange": false,
                      "has_money_transfer": false,
                      "sales_potential": 0,
                      "estimated_yearly_fx_volume": "N/A",
                      "locations": "N/A",
                      "company_summary": "Site inaccessible",
                      "lead_quality_notes": "Error: [exact problem description]",
                      "proof_url": "N/A"
                  }
                  ===PROMPT_END===
                  ===COLUMNS_START===
                  company_name
                  has_international_offices
                  has_currency_exchange
                  has_money_transfer
                  sales_potential
                  estimated_yearly_fx_volume
                  locations
                  company_summary
                  lead_quality_notes
                  proof_url
                  ===COLUMNS_END===
                  </COMPLETE_RESPONSE_EXAMPLE>

                  <PROMPT_REQUIREMENTS>
                  Your prompt MUST include:
                  1. Clear definition of model's role
                  2. Detailed step-by-step analysis instructions
                  3. Specific data processing and validation rules
                  4. Exact JSON response format specification
                  5. Three complete response examples (success, limited, error)
                  6. Instructions for handling non-standard situations

                  Prompt must be comprehensive and self-contained, minimum 3000 characters.
                  </PROMPT_REQUIREMENTS>

                  <RESPONSE_FORMAT_RULES>
                  1. Response must exactly match COMPLETE_RESPONSE_EXAMPLE format
                  2. Prompt section must be at least 3000 characters
                  3. Must have up to 10 specified output columns
                  4. No explanatory text outside specified sections
                  5. Column names must exactly match specification
                  6. JSON format must exactly match examples
                  7. Special instructions:
                     - Don't use personal data (contacts, names) unless task explicitly requires it
                     - Avoid binary assessments (yes/no), use 0-10 scale
                     - Always indicate data source
                     - Describe reasons for low ratings
                     - Note uncertainty in data

                  8. Must include in prompt:
                      - Set model role based on task and data type
                      - Requirement not to make assumptions, write either verified data or report verification impossibility
                      - If task requires visiting sites, give explicit instruction for model to visit site and reference URL column
                      - Questions and tasks for model
                      - 3 json response examples - good analysis result, negative and response for non-standard situation
                      - Requirement to respond strictly in specified Json structure and explanation that data is parsed by program
                      - References to data column names in double curly braces {{}}, needed by model for analysis. But not including column names with "Pending...". If column contains url - give direct instruction to visit it.

                  IMPORTANT:
                  - Don't include existing columns from input data
                  - Don't add explanations after COLUMNS_END or before prompt - your response is processed by program
                  - Use only letters, numbers and underscores in column names
                  - Your response must contain only prompt between ===PROMPT_START=== and ===PROMPT_END=== and columns section between ===COLUMNS_START=== and ===COLUMNS_END=== separators, this is critically important
                  - Don't add anything to response except prompt and columns section at the end!
                  - Write prompt in English unless user requested another language

                  CRITICALLY IMPORTANT:
                  Write prompt in full compliance with response format and CAREFULLY follow all instructions, and require the same from the model.
                  Remember that prompt will be used by automated analysis system, and your mistake could be very costly, while energy for erroneous analysis will leave carbon footprint unnecessarily.

                  REMEMBER, excessive prompt is better than insufficient. Success of large data volume analysis depends on quality of your work. Write detailed prompt as if writing instruction for human.

                  </RESPONSE_FORMAT_RULES>`;

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const DEFAULT_CONFIG = {
        profiles: {
          website_analyzer: {
            name: 'Website Analyzer',
            description:
              '–ê–Ω–∞–ª–∏–∑ —Å–∞–π—Ç–æ–≤ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –ø–æ–µ–Ω—Ü–∏–∞–ª–∞ –¥–ª—è —Ñ–∏–Ω—Ç–µ—Ö —Ä–µ—à–µ–Ω–∏–π',
            prompt: 'You are an AI agent...',
            output_columns: [
              'company_name',
              'has_international_offices',
              'has_currency_exchange',
              'has_money_transfer',
              'sales_potential',
              'estimated_yearly_fx_volume',
              'locations',
              'company_summary',
              'lead_quality_notes',
              'proof_url',
            ],
            model: 'gemini-1.5-pro',
            temperature: 0.0,
          },
          quick_check: {
            name: 'Quick Check',
            description: '–ë—ã—Å—Ç—Ä—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–æ–ª—å–∫–æ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã',
            prompt: 'Visit {url} and analyze ONLY the main page content...', // –≤–µ—Å—å —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞
            output_columns: [
              'company_name',
              'has_international_offices',
              'has_currency_exchange',
              'has_money_transfer',
              'sales_potential',
              'estimated_yearly_fx_volume',
              'locations',
              'company_summary',
              'lead_quality_notes',
              'proof_url',
            ],
            model: 'gemini-1.5-pro',
            temperature: 0.0,
          },
        },
      };

      // –£–±–∏—Ä–∞–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
      function loadConfig() {
        return DEFAULT_CONFIG;
      }

      function saveConfig(config) {
        return true;
      }

      function initConfig() {
        return DEFAULT_CONFIG;
      }

      // –î–æ–±–∞–≤–ª—èÔøΩÔøΩ–º –ø–æ—ÅÔøΩÔøΩ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —á–∞—Ç–∞
      const DEFAULT_SYSTEM_PROMPT = `I am an AI assistant helping you with data analysis and prompt engineering.

                            When table data is shared:
                            - I will analyze the data and help you understand patterns and insights
                            - I can suggest improvements for data processing
                            - I can help optimize prompts based on the results

                            When preset is shared:
                            - I will help you improve the prompt structure
                            - I can suggest ways to make instructions more clear
                            - I will help optimize the output format

                            I will always:
                            - Provide clear explanations
                            - Suggest specific improvements
                            - Use examples when helpful
                            - Focus on practical solutions

                            Let me know what you'd like to analyze or improve!`;

      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
      function getTableData() {
        const table = document.getElementById('resultsTable');
        if (!table) return null;

        const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent);
        const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
          const row = {};
          Array.from(tr.cells).forEach((cell, i) => {
            row[headers[i]] = cell.textContent;
          });
          return row;
        });

        return {
          headers: headers,
          rows: rows,
          totalRows: rows.length,
          lastProcessed: rows.filter(row => row.company_name && row.company_name !== 'N/A').length,
        };
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
      document.addEventListener('DOMContentLoaded', async function () {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || '';
        IS_COMMERCIAL_KEY = localStorage.getItem('is_commercial_key') === 'true';
        updateApiKeyStatus();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ø–æ–π–ª–µ—Ä–æ–≤ (–æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –≤—Å–µ—Ö)
        setupCollapsible();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ—Å–µ—Ç–æ–≤
        await updatePresetList();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        loadChatHistory();
        setupMessageInput();
        setupDragAndDrop();

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º Settings –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º README
        const collapsibles = document.getElementsByClassName('collapsible');
        Array.from(collapsibles).forEach(button => {
          const content = button.nextElementSibling;
          if (button.textContent.includes('Settings')) {
            button.classList.add('active');
            content.style.display = 'block';
          } else if (button.textContent.includes('README')) {
            button.classList.remove('active');
            content.style.display = 'none';
          }
        });

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        document.getElementById('systemPrompt').value = DEFAULT_SYSTEM_PROMPT;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–∑–æ–≤ updateButtonsState –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        updateButtonsState();

        // Initialize chat
        setupMessageInput();
        loadChatHistory();

        // Setup context checkboxes
        document.getElementById('includeTableData').addEventListener('change', function (e) {
          chatState.context.includeTableData = e.checked;
        });

        document.getElementById('includePreset').addEventListener('change', function (e) {
          chatState.context.includePreset = e.checked;
        });
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é setupCollapsible
      function setupCollapsible() {
        var coll = document.getElementsByClassName('collapsible');
        for (var i = 0; i < coll.length; i++) {
          coll[i].addEventListener('click', function (e) {
            e.stopPropagation();

            this.classList.toggle('active');
            var content = this.nextElementSibling;

            if (content.style.display === 'block') {
              content.style.display = 'none';
            } else {
              content.style.display = 'block';

              // –ï—Å–ª–∏ —ç—Ç–æ —Å–µ–∫—Ü–∏—è —á–∞—Ç–∞, –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
              if (this.textContent.includes('Chat')) {
                // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ—Ç—Ä–∏—Å–æ–≤–∫—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                setTimeout(() => {
                  window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth',
                  });
                }, 100);
              }
            }
          });
        }
      }

      function loadSavedSettings() {
        const apiKey = localStorage.getItem('geminiApiKey');
        const promptTemplate = localStorage.getItem('promptTemplate');
        const outputColumns = localStorage.getItem('outputColumns');

        if (apiKey) document.getElementById('apiKey').value = apiKey;
        if (promptTemplate) document.getElementById('promptTemplate').value = promptTemplate;
        if (outputColumns) document.getElementById('outputColumns').value = outputColumns;
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—á–∏—Å—Ç–∫–∏ URL
      function cleanUrl(url) {
        // –£–¥–∞–ª—è–µ–º –ø—Ä–æ—Ç–æ–∫–æ–ª (http://, https://, etc)
        url = url.replace(/^(https?:\/\/)?(www\.)?/i, '');

        // –£–¥–∞–ª—è–µ–º trailing slash –∏ –≤—Å–µ —á—Ç–æ –ø–æ—Å–ª–µ –Ω–µ–≥–æ
        url = url.split('/')[0];

        // –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
        url = url.trim();

        return url;
      }

      // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—ÄÔøΩÔøΩ–≤–µ—Ä–∫ÔøΩÔøΩÔøΩÔøΩ –æ—Ç–≤–µ—Ç–∞ API
      async function checkModelResponse(response) {
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Gemini 1.5 Pro is not available');
          }
          const errorData = await response.json();
          throw new Error(`API request failed: ${errorData.error?.message || response.status}`);
        }

        const result = await response.json();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if (!result?.candidates?.[0]?.content?.parts?.[0]?.text) {
          throw new Error('Invalid API response format');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏
        const response_text = result.candidates[0].content.parts[0].text;
        if (
          response_text &&
          (response_text.includes('I apologize, but I cannot browse the internet') ||
            response_text.includes('I cannot access external websites') ||
            response_text.includes("I don't have the ability to browse"))
        ) {
          throw new Error('Response indicates limited model capabilities');
        }

        return result;
      }

      function validateJsonResponse(jsonData, requiredFields) {
        if (!jsonData) return false;

        return requiredFields.every(field => {
          return jsonData.hasOwnProperty(field);
        });
      }

      function extractJsonFromResponse(response) {
        try {
          // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
          const text = response.toString();

          // –ò—â–µ–º –ø–µ—Ä–≤—É—é { –∏ –ø–æ—Å–ª–µ–¥–Ω—é—é } –≤ —Ç–µ–∫—Å—Ç–µ
          const startIdx = text.indexOf('{');
          const endIdx = text.lastIndexOf('}');

          if (startIdx === -1 || endIdx === -1 || startIdx > endIdx) {
            // JSON –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –æ—Ç–≤–µ—Ç –≤ –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É
            console.log('No JSON structure found in response:', text);
            const outputColumns = document.getElementById('outputColumns').value.trim().split('\n');
            const result = {};
            result[outputColumns[0]] = text;
            outputColumns.slice(1).forEach(col => (result[col] = 'N/A'));
            return result;
          }

          // –ò–∑–≤–ª–µ–∫–∞–µ–º JSON-—á–∞—Å—Ç—å
          const jsonStr = text.slice(startIdx, endIdx + 1);
          const parsed = JSON.parse(jsonStr);
          return parsed;
        } catch (e) {
          // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –≤ –ø–µ—Ä–≤—É—é –∫–æ–ª–æ–Ω–∫—É
          console.log('Failed to parse response:', response, 'Error:', e.message);
          const outputColumns = document.getElementById('outputColumns').value.trim().split('\n');
          const result = {};
          result[outputColumns[0]] = response.toString();
          outputColumns.slice(1).forEach(col => (result[col] = 'N/A'));
          return result;
        }
      }

      function createEmptyResponse(message) {
        const fields = document
          .getElementById('outputColumns')
          .value.trim()
          .split('\n')
          .filter(col => col);

        const response = {};
        fields.forEach(field => (response[field] = 'N/A'));
        return response;
      }

      function addResult(url, response, isError = false) {
        const resultsDiv = document.getElementById('results');
        const resultElement = document.createElement('div');
        resultElement.className = `result ${isError ? 'error' : 'success'}`;

        let jsonData;
        if (isError) {
          jsonData = createEmptyResponse();
        } else {
          jsonData = extractJsonFromResponse(response);
        }

        resultElement.innerHTML = `
                                            <strong>URL:</strong> ${url}<br>
                                            <strong>Response:</strong><br>
                                            ${JSON.stringify(jsonData, null, 2)}
                                        `;

        resultsDiv.insertBefore(resultElement, resultsDiv.firstChild);

        results.push({
          url: url,
          data: jsonData,
          timestamp: new Date().toISOString(),
        });
      }

      function convertToCSV(results) {
        const outputColumns = document
          .getElementById('outputColumns')
          .value.trim()
          .split('\n')
          .map(col => col.trim());

        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        let csv = ['URL', ...outputColumns].join(',') + '\n';

        // –î–∞–Ω–Ω—ã–µ
        results.forEach(result => {
          const row = [result.url];
          const jsonData = extractJsonFromResponse(result.response);

          if (jsonData) {
            outputColumns.forEach(col => {
              let value = jsonData[col] || '';
              // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–ø—è—Ç—ã–µ –∏ –∫–∞–≤—ã—á–∫–∏
              if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                value = `"${value.replace(/"/g, '""')}"`;
              }
              row.push(value);
            });
          } else {
            outputColumns.forEach(() => row.push('N/A'));
          }

          csv += row.join(',') + '\n';
        });

        return csv;
      }

      function downloadExcel() {
        const csv = convertToCSV(results);
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `results_${new Date().toISOString()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function updateProgress(current, total) {
        const percentage = (current / total) * 100;
        document.querySelector('.progress-bar-fill').style.width = percentage + '%';
      }

      function updateStatus(message, current, total) {
        const status = document.getElementById('status');
        if (current !== undefined && total !== undefined) {
          status.textContent = `${message} (${current}/${total})`;
        } else {
          status.textContent = message;
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
      function initTable(data) {
        const headers = [
          'URL',
          ...document.getElementById('outputColumns').value.trim().split('\n'),
        ];
        const headerRow = document.getElementById('headerRow');
        headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join('');

        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É

        // –°–æ–∑–¥–∞–µ–º –ø—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –≤—Å–µ—Ö URL
        data.split('\n').forEach(url => {
          if (!url.trim()) return;

          const row = tbody.insertRow();
          row.id = `row-${url.trim()}`;
          headers.forEach((_, i) => {
            const cell = row.insertCell(i);
            if (i === 0) cell.textContent = url.trim();
            else cell.textContent = 'Pending...';
          });
        });
      }

      // –û–±–Ω–æ–≤–ª–µ–ΩÔøΩÔøΩ–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑—É—å—Ç–∞—Ç–∞
      function updateTableRow(index, data) {
        const row = document.getElementById(`row-${index}`);
        if (!row) return;

        const outputColumns = document
          .getElementById('outputColumns')
          .value.trim()
          .split('\n')
          .filter(col => col);

        const startIndex = row.cells.length - outputColumns.length;

        outputColumns.forEach((field, i) => {
          const cell = row.cells[startIndex + i];
          cell.textContent = data[field] || 'N/A';
        });

        row.classList.remove('processing-row');
        row.classList.add(data.company_name === 'N/A' ? 'error-row' : 'success-row');
      }

      // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é highlightProcessingRow
      function highlightProcessingRow(index) {
        const row = document.getElementById(`row-${index}`);
        if (row) {
          row.classList.add('processing-row');
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      // –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏
      const REQUEST_DELAY = 30500; // —Å–µ–∫—É–Ω–¥ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö

      // –ò —É–ø—Ä–æ—â–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é processUrls, —É–±–∏—Ä–∞—è –ª–∏—à–Ω–µ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
      async function processUrls(data) {
        let lastRequestTime = 0;

        for (let i = 0; i < data.length && isProcessing; i++) {
          const row = data[i];
          const url =
            row.url ||
            row.URL ||
            row.Website ||
            row.website ||
            row.WEBSITE ||
            row.Domain ||
            row.domain;
          if (!url) continue;

          const cleanedUrl = cleanUrl(url);
          highlightProcessingRow(i);
          updateStatus(`Processing: ${cleanedUrl}`, i + 1, data.length);

          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∫–ª—é—á–µ–π
          if (!IS_COMMERCIAL_KEY) {
            const currentTime = Date.now();
            const timeSinceLastRequest = currentTime - lastRequestTime;
            if (timeSinceLastRequest < REQUEST_DELAY) {
              await new Promise(resolve =>
                setTimeout(resolve, REQUEST_DELAY - timeSinceLastRequest)
              );
            }
          }

          try {
            lastRequestTime = Date.now();
            const response = await makeRequest(cleanedUrl, GEMINI_API_KEY);
            const jsonData = extractJsonFromResponse(response);
            updateTableRow(i, jsonData);

            results.push({
              ...row,
              ...jsonData,
              timestamp: new Date().toISOString(),
            });
          } catch (error) {
            console.error(`Error processing ${cleanedUrl}:`, error);
            const errorResponse = createEmptyResponse();
            errorResponse[Object.keys(errorResponse)[0]] = error.message;
            updateTableRow(i, errorResponse);
          }
        }

        isProcessing = false;
        updateStatus('Processing completed', data.length, data.length);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é startProcessing
      function startProcessing() {
        if (!GEMINI_API_KEY) {
          alert('Please set your Gemini API Key first');
          showApiKeyForm();
          return;
        }

        const table = document.getElementById('resultsTable');
        if (!table || table.rows.length <= 1) {
          alert('Please upload data file first');
          return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–æ–Ω –µ–µ–¥ –Ω–∞ÔøΩÔøΩ–∞–ª–º –∞–Ω–∞–ª–∏–∑–∞
        updateTableColumns();

        isProcessing = true;
        const data = tableToData();
        processUrls(data);
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤ –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤
      function tableToData() {
        const table = document.getElementById('resultsTable');
        const headers = Array.from(table.rows[0].cells).map(cell => cell.textContent);
        const data = [];

        for (let i = 1; i < table.rows.length; i++) {
          const row = table.rows[i];
          const rowData = {};
          headers.forEach((header, j) => {
            rowData[header] = row.cells[j].textContent;
          });
          data.push(rowData);
        }

        return data;
      }

      function stopProcessing() {
        isProcessing = false;
        updateStatus('Processing stopped');
      }

      function downloadResults() {
        const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `results_${new Date().toISOString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–µ—Å–µ—Ç–∞–º–∏
      async function updatePresetList() {
        const presets = getPresets();
        const select = document.getElementById('presetSelect');
        select.innerHTML = '<option value="">Select preset...</option>';

        Object.keys(presets).forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
      }

      function loadPreset() {
        const presetName = document.getElementById('presetSelect').value;
        if (!presetName) return;

        const presets = getPresets();
        const preset = presets[presetName];
        if (!preset) return;

        document.getElementById('promptTemplate').value = preset.prompt;
        document.getElementById('outputColumns').value = preset.columns;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å–æ–∑–¥–∞–Ω–∞
        const table = document.getElementById('resultsTable');
        if (table && table.rows.length > 0) {
          updateTableColumns();
        }
      }

      function showSavePresetDialog() {
        document.getElementById('savePresetDialog').style.display = 'block';
        document.getElementById('presetName').focus();
      }

      function hideSavePresetDialog() {
        document.getElementById('savePresetDialog').style.display = 'none';
        document.getElementById('presetName').value = '';
      }

      function savePreset() {
        const name = document.getElementById('presetName').value.trim();
        if (!name) {
          alert('Please enter preset name');
          return;
        }

        const presets = getPresets();
        presets[name] = {
          prompt: document.getElementById('promptTemplate').value,
          columns: document.getElementById('outputColumns').value,
        };

        if (savePresets(presets)) {
          updatePresetList();
          hideSavePresetDialog();
          alert('Preset saved successfully');
        } else {
          alert('Error saving preset');
        }
      }

      function deletePreset() {
        const name = document.getElementById('presetSelect').value;
        if (!name || !confirm(`Delete preset "${name}"?`)) return;

        const presets = getPresets();
        delete presets[name];

        if (savePresets(presets)) {
          updatePresetList();
          alert('Preset deleted');
        } else {
          alert('Error deleting preset');
        }
      }

      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞/—ç–∫—Å–ø–æ—Ä—Ç–∞
      function exportPresets() {
        const presets = getPresets();
        const blob = new Blob([JSON.stringify(presets, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `webmatrix_presets_${new Date().toISOString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function importPresets(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const importedPresets = JSON.parse(e.target.result);
            const currentPresets = getPresets();

            // –û–±—ä–µ–¥–∏–Ω—è–µ–º –ø—Ä–µ—Å–µ—Ç—ã
            const mergedPresets = { ...currentPresets, ...importedPresets };

            if (savePresets(mergedPresets)) {
              updatePresetList();
              alert('Presets imported successfully');
            } else {
              alert('Error importing presets');
            }
          } catch (e) {
            console.error('Import error:', e);
            alert('Error importing presets: Invalid file format');
          }
        };
        reader.readAsText(file);
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
      function getPresets() {
        try {
          const presets = localStorage.getItem('webmatrix_presets');
          return presets ? JSON.parse(presets) : {};
        } catch (e) {
          console.error('Error loading presets:', e);
          return {};
        }
      }

      function savePresets(presets) {
        try {
          localStorage.setItem('webmatrix_presets', JSON.stringify(presets));
          return true;
        } catch (e) {
          console.error('Error saving presets:', e);
          return false;
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excel/CSV —Ñ–∞–π–ª–∞
      function handleFileUpload(event) {
        const file = event.target.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
          let data;
          if (file.name.endsWith('.csv')) {
            data = parseCSV(e.target.result);
          } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
            const workbook = XLSX.read(e.target.result, { type: 'binary' });
            data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
          }
          initTableWithData(data);
        };

        if (file.name.endsWith('.csv')) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü —Å –¥–∞–Ω–Ω—ã–º–∏
      function initTableWithData(data) {
        if (!data || !data.length) {
          alert('No data found in file');
          return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
        const inputColumns = Object.keys(data[0]);
        const outputColumns = document.getElementById('outputColumns').value.trim().split('\n');
        const allColumns = [...inputColumns, ...outputColumns];

        // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
        const headerRow = document.getElementById('headerRow');
        headerRow.innerHTML = allColumns.map(h => `<th>${h}</th>`).join('');

        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = '';

        data.forEach((row, index) => {
          const tr = tbody.insertRow();
          tr.id = `row-${index}`;

          // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
          inputColumns.forEach(col => {
            const cell = tr.insertCell();
            const content = row[col] || '';
            cell.textContent = formatCellContent(content);
            cell.title = content; // –ü–ª–Ω—ã–π –µ–∫—Å—Ç –≤ —É—Ç–∏–µ
          });

          // –î–æ–±–∞–≤–ª—è–µ–º —è—á–µ–π–∫–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
          outputColumns.forEach(() => {
            const cell = tr.insertCell();
            cell.textContent = 'Pending...';
          });
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏:
        updateButtonsState();
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–¥–µ—Ä–∂–∏–º–æ–≥–æ —è—á–µ–π–∫–∏
      function formatCellContent(content, maxLength = 50) {
        if (content === null || content === undefined) return 'N/A';

        content = content.toString();
        if (content.length <= maxLength) return content;

        return content.substring(0, maxLength) + '...';
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
      const styles = `
                                        .table-container {
                                            max-height: 600px;
                                            overflow-y: auto;
                                            border: 1px solid #ddd;
                                        }

                                        #resultsTable {
                                            width: 100%;
                                            border-collapse: collapse;
                                            table-layout: fixed; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—è —à–∏—Ä–∏–∞ –∫–æ–ª–æ–Ω–æ–∫ */
                                        }

                                        #resultsTable th, #resultsTable td {
                                            border: 1px solid #ddd;
                                            padding: 8px;
                                            text-align: left;
                                            overflow: hidden;
                                            text-overflow: ellipsis;
                                            white-space: nowrap;
                                            max-width: 200px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —è—á–µ–π–∫–∏ */
                                        }

                                        #resultsTable th {
                                            position: sticky;
                                            top: 0;
                                            background: white;
                                            z-index: 1;
                                        }

                                        #resultsTable td:hover {
                                            white-space: normal;
                                            word-wrap: break-word;
                                            background-color: #f8f9fa;
                                            position: relative;
                                        }

                                        /* –¢—É–ª—Ç–∏–ø –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
                                        #resultsTable td[title]:hover::after {
                                            content: attr(title);
                                            position: absolute;
                                            bottom: 100%;
                                            left: 0;
                                            background: #333;
                                            color: white;
                                            padding: 5px;
                                            border-radius: 3px;
                                            max-width: 300px;
                                            word-wrap: break-word;
                                            z-index: 2;
                                        }
                                    `;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é updateTableRow –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–æ–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
      function updateTableRow(index, data) {
        const row = document.getElementById(`row-${index}`);
        if (!row) return;

        const outputColumns = document.getElementById('outputColumns').value.trim().split('\n');
        const startIndex = row.cells.length - outputColumns.length;

        outputColumns.forEach((field, i) => {
          const cell = row.cells[startIndex + i];
          const content = data[field] || 'N/A';
          cell.textContent = formatCellContent(content);
          cell.title = content; // –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Ç—É–ª—Ç–∏–ø–µ
        });

        row.classList.remove('processing-row');
        row.classList.add(data.company_name === 'N/A' ? 'error-row' : 'success-row');
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ CSV
      function parseCSV(text) {
        const lines = text.split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const data = [];

        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = lines[i].split(',');
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index] ? values[index].trim() : '';
          });
          data.push(row);
        }

        return data;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—è –∫–æ–ª–æ–Ω–æ–∫ —Ç–±–ª–∏—Ü—ã
      function updateTableColumns() {
        const table = document.getElementById('resultsTable');
        if (!table) return;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –∑–∞–ø—É—â–µ–Ω –∞–Ω–∞–ª–∏–∑
        const firstResponseCell = table.rows[1]?.cells[1]?.textContent;
        if (firstResponseCell && firstResponseCell !== 'Pending...') {
          const confirmOverwrite = confirm(
            'A previous analysis was detected. Starting a new analysis will overwrite existing results. Do you want to continue?'
          );
          if (!confirmOverwrite) {
            return;
          }
        }

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        while (table.rows[0].cells.length > 1) {
          for (let i = 0; i < table.rows.length; i++) {
            table.rows[i].deleteCell(1);
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ outputColumns
        const columns = document.getElementById('outputColumns').value.trim().split('\n');
        columns.forEach(column => {
          const th = document.createElement('th');
          th.textContent = column;
          table.rows[0].appendChild(th);

          for (let i = 1; i < table.rows.length; i++) {
            const td = document.createElement('td');
            td.textContent = 'Pending...';
            table.rows[i].appendChild(td);
          }
        });
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ cssRules
      function applyStyles() {
        const styleElement = document.createElement('style');
        styleElement.textContent = `
          .processing-row { background-color: #fff3cd; }
          .error-row { background-color: #ffe6e6; }
          .success-row { background-color: #f0fff0; }
        `;
        document.head.appendChild(styleElement);
      }

      // –í—ã–∑—ã–≤–∞–µ–º applyStyles –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener('DOMContentLoaded', function () {
        applyStyles();
        // ... existing initialization code ...
      });

      // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è –ª—é–±—ã—Ö —Å—Ç—Ä–æ–∫, –∫–æ—Ç–æ—ã–µ –æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å URL
      function cleanPossibleUrl(text) {
        // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Ö–æ–∂ –Ω–∞ URL, –æ—á–∏—â–∞–µ–º –µ–≥–æ
        if (
          text.includes('.') &&
          (text.includes('http') || text.includes('www') || text.includes('/'))
        ) {
          return text
            .replace(/^(https?:\/\/)?(www\.)?/i, '')
            .split('/')[0]
            .trim();
        }
        return text;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
      function getDataContext() {
        const table = document.getElementById('resultsTable');
        if (!table || table.rows.length <= 1) return null;

        const headers = Array.from(table.rows[0].cells).map(cell => cell.textContent);
        const sampleData = [];

        // –ü–æ–ª—É—á–∞–µ–º –¥–æ 3 —Å—Ç—Ä–æ–∫ –∫–∞–∫ –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
        for (let i = 1; i < Math.min(4, table.rows.length); i++) {
          const row = {};
          Array.from(table.rows[i].cells).forEach((cell, j) => {
            row[headers[j]] = cell.textContent;
          });
          sampleData.push(row);
        }

        return {
          headers: headers,
          totalRows: table.rows.length - 1,
          sampleData: sampleData,
        };
      }

      function updateApiKeyStatus() {
        const message = document.getElementById('apiKeyMessage');
        const button = document.getElementById('apiKeyButton');

        if (GEMINI_API_KEY) {
          message.textContent = 'API Key is set';
          message.style.color = '#28a745';
          button.textContent = 'Change API Key';
        } else {
          message.textContent = 'API Key required';
          message.style.color = '#dc3545';
          button.textContent = 'Set API Key';
        }
      }

      function showApiKeyForm() {
        document.getElementById('apiKeyForm').style.display = 'flex';
        document.getElementById('apiKeyInput').focus();
      }

      function hideApiKeyForm() {
        document.getElementById('apiKeyForm').style.display = 'none';
        document.getElementById('apiKeyInput').value = '';
      }

      function saveApiKey() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        const isCommercial = document.getElementById('isCommercialKey').checked;

        if (!apiKey) {
          alert('Please enter API Key');
          return;
        }

        try {
          localStorage.setItem('gemini_api_key', apiKey);
          localStorage.setItem('is_commercial_key', isCommercial);
          GEMINI_API_KEY = apiKey;
          IS_COMMERCIAL_KEY = isCommercial;
          updateApiKeyStatus();
          hideApiKeyForm();
        } catch (e) {
          alert('Error saving API Key to localStorage');
          console.error('Storage error:', e);
        }
      }

      function showExportPresetDialog() {
        document.getElementById('exportPresetDialog').style.display = 'block';
        const defaultName = `webmatrix_presets_${new Date().toISOString().split('T')[0]}`;
        document.getElementById('exportPresetName').value = defaultName;
        document.getElementById('exportPresetName').focus();
      }

      function hideExportPresetDialog() {
        document.getElementById('exportPresetDialog').style.display = 'none';
        document.getElementById('exportPresetName').value = '';
      }

      function doExportPresets() {
        const fileName = document.getElementById('exportPresetName').value.trim();
        if (!fileName) {
          alert('Please enter file name');
          return;
        }

        const presets = getPresets();
        const blob = new Blob([JSON.stringify(presets, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileName}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        hideExportPresetDialog();
      }

      function downloadCSV() {
        const table = document.getElementById('resultsTable');
        if (!table) return;

        let csv = [];
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏
        let headers = [];
        for (let cell of table.rows[0].cells) {
          headers.push(cell.textContent);
        }
        csv.push(headers.join(','));

        // –î–∞–Ω–Ω—ã–µ
        for (let i = 1; i < table.rows.length; i++) {
          let row = [];
          for (let cell of table.rows[i].cells) {
            let value = cell.textContent || '';
            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∑–∞–ø—è—Ç—ã–µ –∏ –∫–∞–≤—ã—á–∫–∏
            if (value.includes(',') || value.includes('"')) {
              value = `"${value.replace(/"/g, '""')}"`;
            }
            row.push(value);
          }
          csv.push(row.join(','));
        }

        const blob = new Blob(['\ufeff' + csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `results_${new Date().toISOString()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —á–∞—Ç–∞
      let chatHistory = [];
      const MAX_HISTORY = 100;
      const MAX_CONTEXT = 10;
      const CHAT_HISTORY_LIMIT = 10; // 10 –ø–∞—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
      const TABLE_ROW_LIMIT = 500; // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 500 —Å—Ç—Ä–æ–∫

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
      function setupMessageInput() {
        const input = document.getElementById('messageInput');

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        input.addEventListener('keydown', e => {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã
        input.addEventListener('input', function () {
          // –ï—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É
          if (!this.value.trim()) {
            this.style.height = '100px';
            return;
          }

          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç
          this.style.height = '100px';

          // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –≤—ã—Å–æ—Ç
          const newHeight = Math.min(this.scrollHeight, window.innerHeight * 0.5);

          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é —ã—Å–æ—Ç—É
          this.style.height = Math.max(100, newHeight) + 'px';
        });
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
      function addMessage(text, sender, save = true) {
        const container = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}-message`;

        // –†–µ–Ω–¥–µ—Ä–∏–º Markdown
        const rendered = marked.parse(text, {
          gfm: true, // GitHub Flavored Markdown
          breaks: true, // Convert \n to <br>
          highlight: function (code, lang) {
            if (lang && hljs.getLanguage(lang)) {
              try {
                const highlighted = hljs.highlight(code, { language: lang }).value;
                return `<div class="code-wrapper">
                                                                    <button class="copy-button" onclick="copyCode(this)">Copy</button>
                                                                    ${highlighted}
                                                                </div>`;
              } catch (err) {}
            }
            return code;
          },
        });

        messageDiv.innerHTML = rendered;

        // –ê–∫—Ç–∏–≤—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
        messageDiv.querySelectorAll('pre code').forEach(block => {
          hljs.highlightBlock(block);
        });

        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º  –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if (save) {
          chatHistory.push({ sender, text });
          if (chatHistory.length > MAX_HISTORY) {
            chatHistory.shift();
          }
          saveChatHistory();
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
      async function sendMessage() {
        if (chatState.isProcessing) {
          alert('Message is being processed, please wait');
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = '';
        appendMessage('user', message);

        chatState.isProcessing = true;
        try {
          let context = '';

          if (chatState.context.includePreset) {
            context += `Current Analyzer Preset:
      Prompt: ${document.getElementById('promptTemplate').value}
      Output Columns: ${document.getElementById('outputColumns').value}\n\n`;
          }

          if (chatState.context.includeTableData) {
            const tableData = getTableDataForChat();
            if (tableData) {
              context += `Table Data:
      Headers: ${tableData.headers.join(', ')}
      Total Rows: ${tableData.totalRows}
      Sample Data: ${JSON.stringify(tableData.rows.slice(0, 3), null, 2)}\n\n`;
            }
          }

          const systemPrompt = document.getElementById('systemPrompt').value;
          const fullPrompt = `${systemPrompt}\n\nContext:\n${context}\n\nChat History:\n${formatChatHistory()}\n\nUser: ${message}`;

          const response = await fetch(
            `${API_CONFIG.BASE_URL}/${API_CONFIG.MODEL}${API_CONFIG.ENDPOINT}?key=${GEMINI_API_KEY}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: fullPrompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 2048,
                  topP: 0.8,
                  topK: 40,
                },
              }),
            }
          );

          const result = await checkChatResponse(response);
          const aiMessage = result.candidates[0].content.parts[0].text;

          appendMessage('assistant', aiMessage);
          updateChatState(aiMessage, 'assistant');
        } catch (error) {
          console.error('Error sending message:', error);
          appendMessage('error', 'Error: ' + error.message);
          updateChatState('Error: ' + error.message, 'error');
        } finally {
          chatState.isProcessing = false;
        }
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
      function getContext() {
        const context = {
          systemPrompt: document.getElementById('systemPrompt').value,
          showTable: document.getElementById('showTable').checked,
          showPreset: document.getElementById('showPreset').checked,
          history: chatHistory.slice(-MAX_CONTEXT),
        };

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        if (context.showTable) {
          context.tableData = getTableData();
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Å–µ—Ç –µ—Å–ª–∏ –≤–∫–ª—é—á–Ω–æ
        if (context.showPreset) {
          context.preset = {
            prompt: document.getElementById('promptTemplate').value,
            columns: document.getElementById('outputColumns').value.split('\n'),
          };
        }

        return context;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ API
      async function sendToAPI(prompt, apiKey, config) {
        console.log('Sending prompt:', prompt); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        const response = await fetch(
          `${API_CONFIG.BASE_URL}/${API_CONFIG.MODEL}${API_CONFIG.ENDPOINT}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-goog-api-key': apiKey,
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: prompt, // –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç –Ω–∞–ø—Ä—è–º—É—é –∏–∑ makeRequest
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: config.temperature || 0.0,
                maxOutputTokens: 2048,
                topP: 0.8,
                topK: 40,
              },
              safetySettings: [
                {
                  category: 'HARM_CATEGORY_HARASSMENT',
                  threshold: 'BLOCK_NONE',
                },
                {
                  category: 'HARM_CATEGORY_HATE_SPEECH',
                  threshold: 'BLOCK_NONE',
                },
              ],
            }),
          }
        );

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`API request failed: ${errorData.error?.message || response.status}`);
        }

        const result = await response.json();
        return result.candidates[0].content.parts[0].text;
      }

      // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é exportPresets
      function exportPresets() {
        const presets = getPresets();
        const blob = new Blob([JSON.stringify(presets, null, 2)], {
          type: 'application/json',
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `webmatrix_presets_${new Date().toISOString()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      async function handleChatFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        await processFile(file);
      }

      function checkModelResponse(result) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –º–æ–¥–µ–∏
        if (result.candidates?.[0]?.citationMetadata?.citations?.[0]?.startIndex === 0) {
          return {
            error: true,
            message: 'API is using a different model than requested. Results may be unreliable!',
          };
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–∏–∑–Ω–∞–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
        const response_text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        if (
          response_text &&
          (response_text.includes('I apologize, but I cannot browse the internet') ||
            response_text.includes('I cannot access external websites') ||
            response_text.includes("I don't have the ability to browse"))
        ) {
          return {
            error: true,
            message: 'Response indicates limited model capabilities',
          };
        }

        return { error: false };
      }

      // –§—É–Ω–∫—Ü–∏–∏ –ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞
      function saveChatHistory() {
        try {
          localStorage.setItem('webmatrix_chat_history', JSON.stringify(chatHistory));
        } catch (e) {
          console.error('Error saving chat history:', e);
        }
      }

      function loadChatHistory() {
        const savedHistory = localStorage.getItem('chatHistory');
        if (savedHistory) {
          chatState.history = JSON.parse(savedHistory);
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
          const chatContainer = document.getElementById('chatMessages');
          if (chatContainer) {
            chatState.history.forEach(msg => {
              appendMessage(msg.sender, msg.message);
            });
          }
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤
        const includePresetCheckbox = document.getElementById('includePreset');
        const includeTableDataCheckbox = document.getElementById('includeTableData');

        chatState.context.includePreset = includePresetCheckbox
          ? includePresetCheckbox.checked
          : false;
        chatState.context.includeTableData = includeTableDataCheckbox
          ? includeTableDataCheckbox.checked
          : false;
      }

      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–Ω–∏—è –∫–æ–¥–∞
      function copyCode(button) {
        const codeBlock = button.parentElement.querySelector('code');
        const text = codeBlock.textContent;

        navigator.clipboard
          .writeText(text)
          .then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            setTimeout(() => {
              button.textContent = originalText;
            }, 2000);
          })
          .catch(err => {
            console.error('Failed to copy:', err);
            button.textContent = 'Error!';
          });
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener('DOMContentLoaded', () => {
        loadChatHistory();
        setupMessageInput();
      });

      async function makeRequest(url, apiKey) {
        const processedPrompt = await generatePromptForUrl(url);
        const response = await fetch(
          `${API_CONFIG.BASE_URL}/${API_CONFIG.MODEL}${API_CONFIG.ENDPOINT}?key=${apiKey}`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: processedPrompt,
                    },
                  ],
                },
              ],
              generationConfig: {
                temperature: 0.0,
                maxOutputTokens: 2048,
                topP: 0.05, // –ú–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
                topK: 1, // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —Å–∞–º—ã–π –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω
              },
            }),
          }
        );

        const result = await checkAnalyzerResponse(response);
        return result.candidates[0].content.parts[0].text;
      }
      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é setupDragAndDrop
      function setupDragAndDrop() {
        const dropZone = document.getElementById('chatContainer');

        dropZone.addEventListener('dragover', e => {
          e.preventDefault();
          e.stopPropagation();
        });

        dropZone.addEventListener('drop', e => {
          e.preventDefault();
          e.stopPropagation();

          const files = e.dataTransfer.files;
          if (files.length) {
            handleChatFileUpload({ target: { files: files } });
          }
        });
      }

      // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–ø–æ–∫
      function updateButtonsState() {
        const table = document.getElementById('resultsTable');
        const hasData = table && table.rows.length > 1;

        const magicButton = document.getElementById('magicButton');
        const startButton = document.getElementById('startButton');

        magicButton.disabled = !hasData;
        startButton.disabled = !hasData;

        // –£–ø—Ä–∞–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç–æ–º title –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        if (!hasData) {
          magicButton.setAttribute(
            'title',
            'Please upload data table in Excel or CSV format first to use Magic Prompt and start analysis'
          );
          startButton.setAttribute(
            'title',
            'Please upload data table in Excel or CSV format first to use Magic Prompt and start analysis'
          );
        } else {
          magicButton.removeAttribute('title');
          startButton.removeAttribute('title');
        }
      }

      // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤ API
      async function checkAnalyzerResponse(response) {
        if (!response.ok) {
          throw new Error(`API request failed: ${response.status}`);
        }
        const result = await response.json();
        if (!result?.candidates?.[0]?.content?.parts?.[0]?.text) {
          throw new Error('Invalid API response format');
        }
        return result;
      }

      async function checkPromptMasterResponse(response) {
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Gemini 1.5 Pro is not available');
          }
          const errorData = await response.json();
          throw new Error(`API request failed: ${errorData.error?.message || response.status}`);
        }

        const result = await response.json();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if (!result?.candidates?.[0]?.content?.parts?.[0]?.text) {
          throw new Error('Invalid API response format');
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –ø—Ä–æ–º–ø—Ç–∞ –∏ –∫–æ–ª–æ–Ω–æ–∫
        const text = result.candidates[0].content.parts[0].text;
        if (!text.includes('===PROMPT_START===') || !text.includes('===COLUMNS_START===')) {
          throw new Error('Prompt master response missing required sections');
        }

        return result;
      }

      async function checkChatResponse(response) {
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Gemini 1.5 Pro is not available');
          }
          const errorData = await response.json();
          throw new Error(`API request failed: ${errorData.error?.message || response.status}`);
        }

        const result = await response.json();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if (!result?.candidates?.[0]?.content?.parts?.[0]?.text) {
          throw new Error('Invalid API response format');
        }

        return result;
      }

      // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
      function getTableDataForChat() {
        const table = document.getElementById('resultsTable');
        if (!table || table.rows.length < 2) return null;

        const headers = Array.from(table.rows[0].cells).map(cell => cell.textContent.trim());
        const rows = [];

        // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ TABLE_ROW_LIMIT —Å—Ç—Ä–æ–∫
        const maxRows = Math.min(table.rows.length, TABLE_ROW_LIMIT + 1); // +1 –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞

        for (let i = 1; i < maxRows; i++) {
          const row = {};
          Array.from(table.rows[i].cells).forEach((cell, index) => {
            row[headers[index]] = cell.textContent.trim();
          });
          rows.push(row);
        }

        return {
          headers,
          totalRows: table.rows.length - 1,
          rows,
        };
      }

      function getTableDataForPromptMaster() {
        const table = document.getElementById('resultsTable');
        if (!table || table.rows.length <= 1) return null;

        const headers = Array.from(table.rows[0].cells).map(cell => cell.textContent);
        const sampleData = [];

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–æ 3 —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
        for (let i = 1; i < Math.min(4, table.rows.length); i++) {
          const row = {};
          Array.from(table.rows[i].cells).forEach((cell, j) => {
            row[headers[j]] = cell.textContent;
          });
          sampleData.push(row);
        }

        return {
          headers: headers,
          totalRows: table.rows.length - 1,
          sampleData: sampleData,
        };
      }

      function getTableDataForAnalyzer() {
        const table = document.getElementById('resultsTable');
        if (!table || table.rows.length <= 1) return null;

        const headers = Array.from(table.rows[0].cells).map(cell => cell.textContent);
        const rows = [];

        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ URL –∏ –∏—Ö –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
        for (let i = 1; i < table.rows.length; i++) {
          const cells = Array.from(table.rows[i].cells);
          const url = cells[0].textContent;
          if (url && url !== 'Pending...') {
            rows.push({
              index: i - 1,
              url: url,
            });
          }
        }

        return {
          headers: headers,
          rows: rows,
          totalRows: rows.length,
        };
      }

      // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤ –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
      const PROMPT_MASTER_META_PROMPT = `<RESPONSE_FORMAT_RULES>
                  Your task is to write a detailed prompt for AI model that will analyze data from table.

                  PROMPT REQUIREMENTS:
                  1. Must be at least 3000 characters long
                  2. Must be clear and unambiguous
                  3. Must be self-contained - all requirements in one place
                  4. Must be structured and organized
                  5. Must define clear response format with JSON structure
                  6. Must handle edge cases and errors
                  7. Must include examples of expected responses
                  8. Must include in prompt:
                      - Set model role based on task and data type
                      - Requirement not to make assumptions, write either verified data or report verification impossibility
                      - If task requires visiting sites, give explicit instruction for model to visit site and reference URL column
                      - Questions and tasks for model
                      - 3 json response examples - good analysis result, negative and response for non-standard situation
                      - Requirement to respond strictly in specified Json structure and explanation that data is parsed by program
                      - References to data column names in double curly braces {{}}, needed by model for analysis. But not including column names with "Pending...". If column contains url - give direct instruction to visit it.

                  IMPORTANT:
                  - Don't include existing columns from input data
                  - Don't add explanations after COLUMNS_END or before prompt - your response is processed by program
                  - Use only letters, numbers and underscores in column names
                  - Your response must contain only prompt between ===PROMPT_START=== and ===PROMPT_END=== and columns section between ===COLUMNS_START=== and ===COLUMNS_END=== separators, this is critically important
                  - Don't add anything to response except prompt and columns section at the end!
                  - Write prompt in English unless user requested another language

                  CRITICALLY IMPORTANT:
                  Write prompt in full compliance with response format and CAREFULLY follow all instructions, and require the same from the model.
                  Remember that prompt will be used by automated analysis system, and your mistake could be very costly, while energy for erroneous analysis will leave carbon footprint unnecessarily.

                  REMEMBER, excessive prompt is better than insufficient. Success of large data volume analysis depends on quality of your work. Write detailed prompt as if writing instruction for human.
                  </RESPONSE_FORMAT_RULES>`;

      const CHAT_DEFAULT_SYSTEM_PROMPT = `I am an AI assistant helping you with data analysis and prompt engineering.

      When table data is shared:
      - I will analyze the data and help you understand patterns and insights
      - I can suggest improvements for data processing
      - I can help optimize prompts based on the results

      When preset is shared:
      - I will help you improve the prompt structure
      - I can suggest ways to make instructions more clear
      - I will help optimize the output format

      I will always:
      - Provide clear explanations
      - Suggest specific improvements
      - Use examples when helpful
      - Focus on practical solutions

      Let me know what you'd like to analyze or improve!`;

      // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≥–µ–Ω—Ç–∞
      const promptMasterState = {
        lastGeneratedPrompt: null,
        lastGeneratedColumns: null,
        isGenerating: false,
      };

      const analyzerState = {
        results: [],
        processedUrls: new Set(),
        isProcessing: false,
        currentIndex: 0,
        errors: [],
      };

      const chatState = {
        history: [],
        context: {
          includePreset: false,
          includeTableData: false,
        },
        isProcessing: false,
      };

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –º–∞—Å—Ç–µ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
      function updatePromptMasterState(prompt, columns) {
        promptMasterState.lastGeneratedPrompt = prompt;
        promptMasterState.lastGeneratedColumns = columns;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
        localStorage.setItem('lastGeneratedPrompt', prompt);
        localStorage.setItem('lastGeneratedColumns', columns);
      }

      function loadPromptMasterState() {
        const savedPrompt = localStorage.getItem('lastGeneratedPrompt');
        const savedColumns = localStorage.getItem('lastGeneratedColumns');

        if (savedPrompt) {
          document.getElementById('promptTemplate').value = savedPrompt;
        }
        if (savedColumns) {
          document.getElementById('outputColumns').value = savedColumns;
        }
      }

      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞
      function updateAnalyzerState(url, result, error = null) {
        if (error) {
          analyzerState.errors.push({ url, error });
        } else {
          analyzerState.results.push({
            url,
            ...result,
            timestamp: new Date().toISOString(),
          });
          analyzerState.processedUrls.add(url);
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        localStorage.setItem('analyzerResults', JSON.stringify(analyzerState.results));
        localStorage.setItem('processedUrls', JSON.stringify([...analyzerState.processedUrls]));
      }

      function loadAnalyzerState() {
        const savedResults = localStorage.getItem('analyzerResults');
        const savedUrls = localStorage.getItem('processedUrls');

        if (savedResults) {
          analyzerState.results = JSON.parse(savedResults);
        }
        if (savedUrls) {
          analyzerState.processedUrls = new Set(JSON.parse(savedUrls));
        }
      }

      function loadChatState() {
        const savedHistory = localStorage.getItem('chatHistory');
        if (savedHistory) {
          chatState.history = JSON.parse(savedHistory);
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
          const chatContainer = document.getElementById('chatMessages');
          if (chatContainer) {
            chatState.history.forEach(msg => {
              appendMessage(msg.sender, msg.message);
            });
          }
        }

        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤
        const includePresetCheckbox = document.getElementById('includePreset');
        const includeTableDataCheckbox = document.getElementById('includeTableData');

        chatState.context.includePreset = includePresetCheckbox
          ? includePresetCheckbox.checked
          : false;
        chatState.context.includeTableData = includeTableDataCheckbox
          ? includeTableDataCheckbox.checked
          : false;
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      document.addEventListener('DOMContentLoaded', function () {
        loadPromptMasterState();
        loadAnalyzerState();
        loadChatState();

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
        if (!document.getElementById('systemPrompt').value) {
          document.getElementById('systemPrompt').value = CHAT_DEFAULT_SYSTEM_PROMPT;
        }
      });

      // –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
      function updatePromptMasterUI(prompt, columns) {
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –ø—Ä–æ–º–ø—Ç–∞ –∏ –∫–æ–ª–æ–Ω–æ–∫
        document.getElementById('promptTemplate').value = prompt;
        document.getElementById('outputColumns').value = columns;

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        const statusElement = document.getElementById('status');
        if (statusElement) {
          statusElement.textContent = 'Prompt generated successfully';
          statusElement.className = 'success';
        }

        // –û–±–æ–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        const table = document.getElementById('resultsTable');
        if (table && table.rows.length > 0) {
          updateTableColumns();
        }
      }

      function updateAnalyzerUI(index, data, error = null) {
        const row = document.getElementById(`row-${index}`);
        if (!row) return;

        // –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        const outputColumns = document
          .getElementById('outputColumns')
          .value.trim()
          .split('\n')
          .filter(col => col);

        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        const startIndex = row.cells.length - outputColumns.length;

        if (error) {
          // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —è—á–µ–π–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
          outputColumns.forEach((_, i) => {
            const cell = row.cells[startIndex + i];
            cell.textContent = 'Error: ' + error.message;
            cell.className = 'error-cell';
          });
          row.className = 'error-row';
        } else {
          // –ó–∞–ø–æ–ª–Ω—è–µ–º —è—á–µ–π–∫–∏ –¥–∞–Ω–Ω—ã–º–∏
          outputColumns.forEach((field, i) => {
            const cell = row.cells[startIndex + i];
            const value = data[field];
            cell.textContent = value || 'N/A';
            cell.className = value ? 'success-cell' : 'empty-cell';
          });
          row.className = 'success-row';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        const progress = analyzerState.processedUrls.size;
        const total = document.getElementById('resultsTable').rows.length - 1;
        updateStatus(`Processed ${progress} of ${total} URLs`, progress, total);
      }

      function updateChatUI(message, role) {
        const chatContainer = document.getElementById('chatMessages');
        if (!chatContainer) return;

        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}-message`;

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏
        const timestamp = new Date().toLocaleTimeString();
        const timeSpan = document.createElement('span');
        timeSpan.className = 'message-time';
        timeSpan.textContent = timestamp;

        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ markdown)
        const formattedMessage = formatMessage(message);

        // –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        messageDiv.innerHTML = `
                <div class="message-header">
                  <span class="message-role">${role}</span>
                  ${timeSpan.outerHTML}
                </div>
                <div class="message-content">${formattedMessage}</div>
              `;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        chatContainer.appendChild(messageDiv);

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
        messageDiv.scrollIntoView({ behavior: 'smooth', block: 'end' });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–∞—Ç–∞
        const statusElement = document.getElementById('chatStatus');
        if (statusElement) {
          statusElement.textContent = role === 'user' ? 'Sending...' : 'Ready';
        }
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI
      function formatMessage(message) {
        // –ë–∞–∑–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ markdown
        return message
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>')
          .replace(/`(.*?)`/g, '<code>$1</code>')
          .replace(/\n/g, '<br>');
      }

      function updateStatus(message, current = null, total = null) {
        const statusElement = document.getElementById('status');
        if (!statusElement) return;

        if (current !== null && total !== null) {
          const percentage = Math.round((current / total) * 100);
          statusElement.textContent = `${message} (${percentage}%)`;
        } else {
          statusElement.textContent = message;
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö UI —Ñ—É–Ω–∫—Ü–∏–π
      async function generatePrompt() {
        if (promptMasterState.isGenerating) {
          updateStatus('Already generating prompt, please wait');
          return;
        }

        promptMasterState.isGenerating = true;
        updateStatus('Generating prompt...');

        try {
          const userTask = document.getElementById('promptTemplate').value.trim();
          if (!userTask) {
            throw new Error('Please describe your task in the prompt field');
          }

          const dataContext = getTableDataForPromptMaster();
          if (!dataContext) {
            throw new Error('Please upload data file first');
          }

          const fullContext = `
      USER TASK:
      ${userTask}

      DATA CONTEXT:
      Table has ${dataContext.totalRows} rows with following columns: ${dataContext.headers.join(', ')}

      Sample data (first 3 rows):
      ${JSON.stringify(dataContext.sampleData, null, 2)}

      ${PROMPT_MASTER_META_PROMPT}`;

          const response = await fetch(
            `${API_CONFIG.BASE_URL}/${API_CONFIG.MODEL}${API_CONFIG.ENDPOINT}?key=${GEMINI_API_KEY}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: fullContext,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.0,
                  maxOutputTokens: 2048,
                  topP: 0.8,
                  topK: 40,
                },
              }),
            }
          );

          const result = await checkPromptMasterResponse(response);
          const text = result.candidates[0].content.parts[0].text;
          console.log(text);

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –ø—Ä–æ–º–ø—Ç–µ
          const promptMatch = text.match(/===PROMPT_START===([\s\S]*?)===PROMPT_END===/);
          const columnsMatch = text.match(/===COLUMNS_START===([\s\S]*?)===COLUMNS_END===/);

          if (!promptMatch || !columnsMatch) {
            throw new Error('Response missing required sections');
          }

          const promptText = promptMatch[1].trim();
          const columnsText = columnsMatch[1].trim();

          if (promptText.length < 3000) {
            throw new Error('Generated prompt is too short (min 3000 chars)');
          }

          // –£–ª—É—á—à–∞–µ–º –ø–∞—Ä—Å–∏–≥ –∫–æ–ª–æ–Ω–æ–∫
          const columns = columnsText
            .split(/[\n,]+/) // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç—ã–º –∏ –Ω–æ–≤—ã–º —Å—Ç—Ä–æ–∫–∞–º
            .map(col => col.trim())
            .filter(col => {
              return (
                col &&
                !col.startsWith('-') &&
                !col.startsWith('*') &&
                !col.includes(' ') &&
                /^[a-zA-Z0-9_]+$/.test(col)
              );
            })
            .join('\n');

          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          updatePromptMasterState(promptText, columns);
          document.getElementById('promptTemplate').value = promptText;
          document.getElementById('outputColumns').value = columns;

          const table = document.getElementById('resultsTable');
          if (table && table.rows.length > 0) {
            updateTableColumns();
          }

          updateStatus('Prompt generated successfully');
          return true;
        } catch (error) {
          console.error('Error generating prompt:', error);
          updateStatus('Error: ' + error.message, 'error');
          return false;
        } finally {
          promptMasterState.isGenerating = false;
        }
      }

      async function processUrls(data) {
        let lastRequestTime = 0;

        for (let i = 0; i < data.length && isProcessing; i++) {
          const row = data[i];
          const url =
            row.url ||
            row.URL ||
            row.Website ||
            row.website ||
            row.WEBSITE ||
            row.Domain ||
            row.domain;
          if (!url) continue;

          const cleanedUrl = cleanUrl(url);
          highlightProcessingRow(i);
          updateStatus(`Processing: ${cleanedUrl}`, i + 1, data.length);

          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏—Ö –∫–ª—é—á–µ–π
          if (!IS_COMMERCIAL_KEY) {
            const currentTime = Date.now();
            const timeSinceLastRequest = currentTime - lastRequestTime;
            if (timeSinceLastRequest < REQUEST_DELAY) {
              await new Promise(resolve =>
                setTimeout(resolve, REQUEST_DELAY - timeSinceLastRequest)
              );
            }
          }

          try {
            lastRequestTime = Date.now();
            const response = await makeRequest(cleanedUrl, GEMINI_API_KEY);
            const jsonData = extractJsonFromResponse(response);
            updateTableRow(i, jsonData);

            results.push({
              ...row,
              ...jsonData,
              timestamp: new Date().toISOString(),
            });
          } catch (error) {
            console.error(`Error processing ${cleanedUrl}:`, error);
            const errorResponse = createEmptyResponse();
            errorResponse[Object.keys(errorResponse)[0]] = error.message;
            updateTableRow(i, errorResponse);
          }
        }

        isProcessing = false;
        updateStatus('Processing completed', data.length, data.length);
      }

      async function sendMessage() {
        if (chatState.isProcessing) {
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = '';
        chatState.isProcessing = true;

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        updateChatUI(message, 'user');
        updateChatState(message, 'user');

        try {
          let context = '';

          if (chatState.context.includePreset) {
            context += `Current Analyzer Preset:
      Prompt: ${document.getElementById('promptTemplate').value}
      Output Columns: ${document.getElementById('outputColumns').value}\n\n`;
          }

          if (chatState.context.includeTableData) {
            const tableData = getTableDataForChat();
            if (tableData) {
              context += `Table Data:
      Headers: ${tableData.headers.join(', ')}
      Total Rows: ${tableData.totalRows}
      Sample Data: ${JSON.stringify(tableData.rows.slice(0, 3), null, 2)}\n\n`;
            }
          }

          const systemPrompt = document.getElementById('systemPrompt').value;
          const fullPrompt = `${systemPrompt}\n\nContext:\n${context}\n\nChat History:\n${formatChatHistory()}\n\nUser: ${message}`;

          const response = await fetch(
            `${API_CONFIG.BASE_URL}/${API_CONFIG.MODEL}${API_CONFIG.ENDPOINT}?key=${GEMINI_API_KEY}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: fullPrompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 2048,
                  topP: 0.8,
                  topK: 40,
                },
              }),
            }
          );

          const result = await checkChatResponse(response);
          const aiMessage = result.candidates[0].content.parts[0].text;

          appendMessage('assistant', aiMessage);
          updateChatState(aiMessage, 'assistant');
        } catch (error) {
          console.error('Error sending message:', error);
          updateChatUI('Error: ' + error.message, 'error');
          updateChatState('Error: ' + error.message, 'error');
        } finally {
          chatState.isProcessing = false;
        }
      }

      function updatechatState(message, sender) {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
        if (chatState.history.length >= CHAT_HISTORY_LIMIT * 2) {
          chatState.history.shift(); // –£–¥–∞–ª—è–µ–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }
        chatState.history.push({ sender, message });
      }

      function formatChatHistory() {
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        return chatState.history.map(entry => `${entry.sender}: ${entry.message}`).join('\n');
      }

      function appendMessage(sender, message) {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ UI –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        updateChatUI(message, sender);
        updatechatState(message, sender);
      }

      // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
      async function sendMessage() {
        if (chatState.isProcessing) {
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = '';
        chatState.isProcessing = true;

        // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        appendMessage('user', message);

        try {
          let context = '';

          if (chatState.context.includePreset) {
            context += `Current Analyzer Preset:
Prompt: ${document.getElementById('promptTemplate').value}
Output Columns: ${document.getElementById('outputColumns').value}\n\n`;
          }

          if (chatState.context.includeTableData) {
            const tableData = getTableDataForChat();
            if (tableData) {
              const limitedRows = tableData.rows.slice(0, TABLE_ROW_LIMIT);
              context += `Table Data:
Headers: ${tableData.headers.join(', ')}
Total Rows: ${limitedRows.length}
Sample Data: ${JSON.stringify(limitedRows, null, 2)}\n\n`;
            }
          }

          const systemPrompt = document.getElementById('systemPrompt').value;
          const fullPrompt = `${systemPrompt}\n\nContext:\n${context}\n\nChat History:\n${formatChatHistory()}\n\nUser: ${message}`; // –û–±–Ω–æ–≤–∏–ª–∏ –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏

          const response = await fetch(
            `${API_CONFIG.BASE_URL}/${API_CONFIG.MODEL}${API_CONFIG.ENDPOINT}?key=${GEMINI_API_KEY}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: fullPrompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  temperature: 0.7,
                  maxOutputTokens: 2048,
                  topP: 0.8,
                  topK: 40,
                },
              }),
            }
          );

          const result = await checkChatResponse(response);
          const aiMessage = result.candidates[0].content.parts[0].text;

          appendMessage('assistant', aiMessage);
        } catch (error) {
          console.error('Error sending message:', error);
          updateChatUI('Error: ' + error.message, 'error');
        } finally {
          chatState.isProcessing = false;
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –≤ setupMessageInput
      function setupChatAgentMessageInput() {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });
      }

      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ä–æ–µ –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
      function formatChatHistory() {
        return chatState.history.map(entry => `${entry.sender}: ${entry.message}`).join('\n');
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
      function updateChatUI(message, sender) {
        // ... existing code ...
      }

      function updateChatState(message, sender) {
        if (chatState.history.length >= CHAT_HISTORY_LIMIT * 2) {
          chatState.history.shift();
        }
        chatState.history.push({ sender, message });
      }

      function appendMessage(sender, message) {
        updateChatUI(message, sender);
        updateChatState(message, sender);
      }

      async function sendMessage() {
        if (chatState.isProcessing) {
          return;
        }

        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value.trim();
        if (!message) return;

        messageInput.value = '';
        chatState.isProcessing = true;

        appendMessage('user', message);

        try {
          // ... rest of the sendMessage function remains the same ...
        } catch (error) {
          console.error('Error sending message:', error);
          updateChatUI('Error: ' + error.message, 'error');
        } finally {
          chatState.isProcessing = false;
        }
      }
    </script>
  </body>
</html>
