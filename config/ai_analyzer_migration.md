# Подробное описание логики AI Analyzer (WebMatrix)

## Основной принцип работы

Инструмент позволяет анализировать большие наборы данных с помощью LLM через систему настраиваемых промптов. Ключевая особенность - возможность использовать значения из таблицы как переменные в промпте.

### Процесс анализа

1. **Подготовка промпта**
   - Пользователь создает шаблон промпта с переменными в формате {{variable}}
   - Пример: "Посети {{url}} и определи: 1) Основную тему, 2) Тональность, 3) Ключевые факты"
   - Каждая переменная соответствует колонке во входной таблице
   - Важно: промпт должен требовать ответ в JSON формате для последующего парсинга

2. **Определение выходных колонок**
   - Пользователь указывает названия колонок для результатов
   - Каждая колонка = одно поле в JSON ответе от LLM
   - Пример колонок: "main_topic", "sentiment", "key_facts"
   - Названия должны быть валидными JSON ключами

3. **Загрузка данных**
   - Поддерживаемые форматы: XLSX, CSV
   - При загрузке определяются доступные колонки
   - Создается предпросмотр первых 5-10 строк
   - Важно: корректное определение кодировки для CSV

4. **Процесс анализа**
   - Построчный перебор таблицы
   - Для каждой строки:
     - Подстановка значений в шаблон промпта
     - Отправка запроса к LLM API
     - Парсинг JSON ответа
     - Добавление результатов в новые колонки
   - Поддержка паузы/возобновления
   - Индикация прогресса

### Особенности и "подводные камни"

1. **Работа с промптами**
   - Промпт должен быть самодостаточным (содержать все инструкции)
   - Обязательно требование JSON формата ответа
   - Необходима валидация на наличие всех переменных
   - Промпт не должен быть слишком длинным (лимиты API)

2. **Обработка ответов**
   - Не все ответы будут валидным JSON
   - Необходима обработка частичных ответов
   - Важно сохранение промежуточных результатов
   - Требуется логирование ошибок парсинга

3. **API взаимодействие**
   - Обработка rate limits
   - Retry механизм при ошибках
   - Таймауты и их настройка
   - Валидация API ключей

4. **Работа с данными**
   - Корректная обработка Unicode
   - Экранирование спецсимволов
   - Обработка пустых значений
   - Сохранение форматирования при экспорте

### Ключевые файлы оригинального проекта

1. **Промпты и шаблоны**
   - system_prompts.js - метапромпты системы
   - prompt_templates.js - шаблоны для разных задач
   - prompt_validator.js - валидация промптов

2. **Обработка данных**
   - table_processor.js - работа с таблицами
   - json_parser.js - парсинг ответов
   - variable_substitutor.js - подстановка переменных

3. **API и запросы**
   - api_client.js - работа с LLM API
   - rate_limiter.js - управление очередью
   - error_handler.js - обработка ошибок

### Интерфейс пользователя

1. **Секция промптов**
   - Текстовое поле для промпта
   - Список переменных из таблицы
   - Валидация промпта
   - Предпросмотр подстановки

2. **Секция колонок**
   - Добавление/удаление колонок
   - Валидация имён
   - Предпросмотр структуры

3. **Секция анализа**
   - Загрузка файлов
   - Просмотр таблицы
   - Управление процессом
   - Индикация прогресса
   - Экспорт результатов

### Форматы данных

1. **Входные данные**
   - XLSX (*.xlsx, *.xls)
   - CSV (с определением разделителя)
   - Поддержка различных кодировок

2. **Промежуточные данные**
   - JSON для ответов API
   - Структурированные объекты для результатов
   - Логи операций и ошибок

3. **Выходные данные**
   - XLSX с сохранением форматирования
   - CSV с настройкой разделителя
   - Возможность частичного экспорта

## Мастер промптов (Prompt Master)

### Назначение
Мастер промптов - это специальный агент, который помогает преобразовать запрос пользователя в структурированный промпт для анализа. Его основная задача - обеспечить корректный формат ответов от LLM и упростить создание сложных аналитических запросов.

### Принцип работы
1. **Входные данные**
   - Запрос пользователя в свободной форме
   - Пример: "Проанализируй тексты новостей и выдели главную тему, тональность и ключевые факты"
   - Опционально: примеры данных из таблицы

2. **Обработка запроса**
   - Анализ требуемых полей для извлечения
   - Определение необходимых переменных
   - Формирование структуры JSON ответа
   - Добавление системных инструкций

3. **Результат работы**
   - Готовый промпт с переменными в {{}}
   - Список названий выходных колонок
   - Пример ожидаемого JSON ответа
   - Инструкции по обработке ошибок

### Метапромпт мастера
Содержит следующие ключевые инструкции:
- Требование структурированного JSON ответа
- Правила именования полей
- Обработка краевых случаев
- Ограничения на размер ответа
- Требования к формату данных

### Итеративное улучшение
- Пользователь может корректировать промпт
- Мастер адаптирует изменения под требуемый формат
- Сохраняется история изменений
- Возможность откатиться к предыдущим версиям

### Интеграция с основным процессом
1. **Предварительный анализ**
   - Проверка совместимости переменных
   - Валидация структуры промпта
   - Тестирование на образце данных

2. **Процесс использования**
   - Опциональное обращение к мастеру
   - Возможность ручной доработки
   - Сохранение успешных промптов
   - Переиспользование шаблонов

3. **Обратная связь**
   - Анализ успешности промптов
   - Адаптация под типовые ошибки
   - Улучшение базовых шаблонов

### Особенности реализации
- Метапромпт хранится в коде
- Поддержка мультиязычности
- Оптимизация под конкретные LLM
- Механизмы валидации и нормализации

### Типовые сценарии использования
1. **Создание нового анализа**
   - Описание задачи на естественном языке
   - Получение структурированного промпта
   - Настройка выходных колонок

2. **Улучшение существующего**
   - Загрузка текущего промпта
   - Описание желаемых изменений
   - Получение обновленной версии

3. **Отладка проблем**
   - Анализ ошибок в ответах
   - Корректировка инструкций
   - Улучшение обработки исключений

## Структура исходного проекта

### Корневая директория
^^^
src/
├── styles/                  # CSS стили
│   ├── main.css            # Основные стили
│   ├── table.css           # Стили таблицы
│   └── components/         # Стили компонентов
│       ├── prompt.css      # Стили секции промптов
│       ├── settings.css    # Стили настроек
│       └── analysis.css    # Стили секции анализа
├── components/             # React компоненты
│   ├── Spoiler.js         # Компонент сворачивания/разворачивания
│   ├── Settings.js        # Компонент настроек
│   ├── AnalysisTable.js   # Компонент таблицы анализа
│   └── PromptSection.js   # Компонент работы с промптами
├── agents/                 # Логика агентов
│   ├── PromptMaster.js    # Мастер промптов
│   ├── Analyst.js         # Основной анализатор
│   └── prompts/           # Системные промпты
│       ├── meta.js        # Метапромпт мастера
│       └── templates.js   # Шаблоны промптов
├── utils/                 # Утилиты
│   ├── api.js            # Работа с API
│   ├── storage.js        # Работа с localStorage
│   ├── fileHandlers.js   # Обработка файлов
│   └── validators.js     # Валидаторы
└── index.js              # Точка входа
^^^

### Ключевые файлы и их назначение

1. **agents/PromptMaster.js**
   - Логика мастера промптов
   - Преобразование пользовательских запросов
   - Валидация и форматирование промптов
   - Интеграция с метапромптом

2. **agents/Analyst.js**
   - Основной процесс анализа
   - Управление очередью запросов
   - Обработка ответов LLM
   - Сохранение результатов

3. **agents/prompts/meta.js**
   - Метапромпт системы
   - Инструкции для LLM
   - Шаблоны JSON ответов
   - Правила обработки ошибок

4. **components/AnalysisTable.js**
   - Отображение и редактирование таблицы
   - Управление процессом анализа
   - Экспорт результатов
   - Визуализация прогресса

5. **components/PromptSection.js**
   - Интерфейс работы с промптами
   - Интеграция с мастером промптов
   - Управление переменными
   - Предпросмотр подстановок

6. **utils/api.js**
   - Взаимодействие с LLM API
   - Управление rate limits
   - Обработка ошибок
   - Retry логика

7. **utils/fileHandlers.js**
   - Загрузка XLSX/CSV
   - Парсинг таблиц
   - Экспорт результатов
   - Валидация форматов

8. **utils/storage.js**
   - Работа с localStorage
   - Сохранение пресетов
   - Кэширование результатов
   - Управление состоянием

9. **utils/validators.js**
   - Валидация промптов
   - Проверка JSON структур
   - Валидация колонок
   - Проверка типов данных

### Основные зависимости

1. **Работа с данными**
   - xlsx: чтение/запись Excel
   - papaparse: работа с CSV
   - json-stable-stringify: стабильная сериализация

2. **UI компоненты**
   - react-table: отображение таблиц
   - react-dropzone: загрузка файлов
   - react-toastify: нотификации

3. **Утилиты**
   - lodash: обработка данных
   - axios: HTTP запросы
   - file-saver: сохранение файлов

## План переноса по секциям:

1. **Настройки и API**:
   - Поля API ключа
   - Управление пресетами
   - localStorage интеграция

2. **Промпты и колонки**:
   - Поля ввода
   - Интеграция с мастером промптов
   - Сохранение состояния

3. **Таблица и анализ**:
   - Загрузка данных
   - Отображение результатов
   - Экспорт

## Критические компоненты для проверки:
- Правильность переноса метапромпта
- Сохранение всех функций из монолита
- Корректная работа localStorage
- Поддержка всех форматов файлов
- Правильная обработка ошибок

## Структура:
- Добавить все подспойлеры:
  - 🎯 What can WebMatrix do?
  - 🔄 How does it work?
  - 📚 Ready-made recipes
  - 💬 AI assistant
  - 💡 Useful tips
  - 🚀 Quick start
  - ℹ️ Important to know

## Стили:
- Перенести стили для readme-container
- Восстановить стили для спойлеров
- Добавить стили для карточек и секций
- Проверить работу collapsible механизма

## Контент:
- Восстановить все секции из монолита
- Сохранить форматирование и эмодзи
- Проверить все списки и подсекции

## FIXME
- Стили из монолита не работают.
- Нет 1-й секции - спойлера с ридми.
- Нет секции промпта и колонок.
- Сейчас сделано, что пользователь может только серез алерт ввести запрос,но он должен писать его в полях промпта и колонок. Использование мастера промптов только опционально. Кроме того, мастер промптов может использоваться несколько раз для итеративного улучшения, например, пользователь уточняет прмпт, а мастер снова приводит его в соответствие с ожиданием программы.


